<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Party üéµ</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #0a0e27;
            color: white;
            min-height: 100vh;
        }

        .app { min-height: 100vh; position: relative; }

        .bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 0, 110, 0.1), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(131, 56, 236, 0.1), transparent 50%);
            animation: pulse 8s infinite;
            z-index: 0;
        }

        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

        .screen {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hidden { display: none !important; }

        /* MENU */
        .logo { text-align: center; margin-bottom: 2rem; }
        .title {
            font-family: 'Bungee Shade', cursive;
            font-size: 4rem;
            background: linear-gradient(45deg, #ff006e, #00f5ff, #ffbe0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            font-size: 1.2rem;
            color: #00f5ff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            margin: 0.3rem;
        }

        .btn:hover:not(:disabled) { transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.large { padding: 1.5rem 3rem; font-size: 1.3rem; }
        .btn.secondary { background: linear-gradient(135deg, #00f5ff, #ffbe0b); }
        .btn.danger { background: linear-gradient(135deg, #ff006e, #ff4444); }

        /* INPUTS */
        .input, .select {
            width: 100%;
            max-width: 400px;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #8338ec;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .input:focus, .select:focus { outline: none; border-color: #ff006e; }
        .code-input { font-size: 2rem; text-align: center; letter-spacing: 0.5em; }

        /* SECTIONS */
        .section { margin: 1.5rem 0; text-align: center; width: 100%; max-width: 500px; }
        .section h3 { color: #00f5ff; margin-bottom: 1rem; }

        .num-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .num-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            color: white;
            padding: 0.8rem;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }

        .num-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .num-btn.active { background: linear-gradient(135deg, #ff006e, #8338ec); border-color: #ff006e; }

        /* CHECKBOX */
        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            margin: 0.5rem 0;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .checkbox-label:hover { background: rgba(0, 0, 0, 0.4); }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label span {
            color: #00f5ff;
            font-weight: 600;
        }

        /* PLAYLISTS */
        .playlists-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 1rem 0;
        }

        .playlist-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .playlist-name {
            flex: 1;
            font-weight: 600;
            color: #ffbe0b;
        }

        .playlist-url {
            flex: 2;
            font-size: 0.8rem;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* LOBBY */
        .code-display {
            text-align: center;
            background: linear-gradient(135deg, #1a1f3a, #2a2f4a);
            border: 3px solid #ffbe0b;
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(255, 190, 11, 0.3);
        }

        .code-label { color: #aaa; font-size: 1rem; margin-bottom: 1rem; }
        .code-value {
            font-size: 5rem;
            font-weight: 800;
            color: #ffbe0b;
            letter-spacing: 0.3em;
            text-shadow: 0 0 30px rgba(255, 190, 11, 0.6);
        }

        .players-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .players-box h3 { color: #00f5ff; margin-bottom: 1rem; }

        .player {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .player-num {
            background: #8338ec;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .player-name { flex: 1; font-weight: 600; }

        .waiting { text-align: center; margin-top: 2rem; }
        .waiting p { font-size: 1.2rem; color: #ffbe0b; margin-top: 1rem; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff006e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* GAME */
        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1.5rem;
            background: #1a1f3a;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border: 2px solid #8338ec;
            font-weight: 800;
        }

        .timer { color: #ff006e; font-size: 1.3rem; }
        .score { color: #ffbe0b; font-size: 1.3rem; }

        .game-container {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
            align-items: flex-start;
        }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scoreboard-side {
            width: 250px;
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            position: sticky;
            top: 20px;
        }

        .scoreboard-side h3 {
            color: #00f5ff;
            margin-bottom: 1rem;
            text-align: center;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .score-item.me {
            background: rgba(255, 190, 11, 0.2);
            border: 1px solid #ffbe0b;
        }

        .score-name { font-weight: 600; }
        .score-points { color: #ffbe0b; font-weight: 800; }

        .img-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 1.5rem;
            border-radius: 20px;
            overflow: hidden;
        }

        .cover {
            width: 100%;
            height: 400px;
            object-fit: cover;
            transition: filter 0.3s ease;
        }

        .answer-reveal {
            text-align: center;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid #00f5ff;
        }

        .answer-reveal h4 {
            color: #00f5ff;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .answer-reveal .answer-text {
            color: #ffbe0b;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .audio-box { text-align: center; margin: 1rem 0; }

        .audio-btn {
            background: linear-gradient(135deg, #ffbe0b, #ff006e);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .question-box { width: 100%; max-width: 600px; margin: 0 auto; }

        .q-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: #00f5ff;
            margin-bottom: 1.5rem;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .opt {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            padding: 1.5rem;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .opt:hover { background: rgba(131, 56, 236, 0.2); transform: scale(1.05); }
        .opt.correct { background: rgba(0, 255, 100, 0.2); border-color: #00ff64; }
        .opt.wrong { background: rgba(255, 0, 0, 0.2); border-color: #ff0033; }
        .opt.disabled { cursor: not-allowed; opacity: 0.6; }

        .result {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .result.correct { background: rgba(0, 255, 100, 0.2); border: 2px solid #00ff64; color: #00ff64; }
        .result.wrong { background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0033; color: #ff6b6b; }

        /* LEADERBOARD */
        .leaderboard-title {
            font-size: 3rem;
            font-weight: 800;
            color: #ffbe0b;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(255, 190, 11, 0.5);
        }

        .podium {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .podium-item {
            background: #1a1f3a;
            border: 3px solid #8338ec;
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            min-width: 150px;
        }

        .medal { font-size: 3rem; margin-bottom: 0.5rem; }
        .p-name { font-weight: 800; font-size: 1.2rem; color: #ffbe0b; margin: 0.5rem 0; }
        .p-score { font-size: 1.5rem; font-weight: 800; color: #ff006e; }

        .leaderboard {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 2rem 0;
        }

        .lb-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .rank {
            background: #8338ec;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .name { flex: 1; font-weight: 600; }
        .pts { font-weight: 800; color: #ffbe0b; font-size: 1.2rem; }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-text {
            color: #ffbe0b;
            font-size: 1.5rem;
            font-weight: 800;
            margin-top: 2rem;
        }

        /* BOUTON SECOURS */
        .emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            z-index: 9999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif;
        }

        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .options { grid-template-columns: 1fr; }
            .cover { height: 300px; }
            .code-value { font-size: 3rem; }
            .game-container { flex-direction: column; }
            .scoreboard-side { width: 100%; position: relative; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="bg"></div>

        <!-- LOADING -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Chargement...</div>
        </div>

        <!-- MENU -->
        <div id="menu-screen" class="screen">
            <div class="logo">
                <h1 class="title">QUIZ PARTY</h1>
                <p class="subtitle">üéµ Blind Test Musical</p>
            </div>
            <div class="menu-buttons">
                <button class="btn large" onclick="goToCreate()">üéÆ Cr√©er une partie</button>
                <button class="btn large secondary" onclick="goToJoin()">üë• Rejoindre une partie</button>
                <button class="btn" onclick="goToPlaylists()">üìã G√©rer Playlists</button>
            </div>
        </div>

        <!-- PLAYLISTS -->
        <div id="playlists-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üìã Mes Playlists</h2>
            
            <div class="playlists-box">
                <h3 style="color: #00f5ff; margin-bottom: 1rem;">Playlists enregistr√©es</h3>
                <div id="playlists-list"></div>
                <button class="btn" onclick="showAddPlaylist()" style="margin-top: 1rem;">‚ûï Ajouter une playlist</button>
            </div>

            <div id="add-playlist-form" class="section hidden">
                <h3>Nouvelle Playlist</h3>
                <input id="new-playlist-name" class="input" placeholder="Nom de la playlist">
                <input id="new-playlist-url" class="input" placeholder="URL Deezer">
                <button class="btn" onclick="savePlaylist()">üíæ Enregistrer</button>
            </div>

            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- CREATE -->
        <div id="create-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üéÆ Cr√©er une partie</h2>
            
            <input id="create-name" class="input" placeholder="Ton pseudo" maxlength="20">
            
            <div class="section">
                <h3>üéØ Mode de jeu</h3>
                <select id="create-mode" class="select">
                    <option value="qcm">QCM (Choix multiples)</option>
                    <option value="writing">√âcriture (Titre + Artiste)</option>
                    <option value="title-only">Titres uniquement</option>
                    <option value="soiree">Soir√©e (Mix QCM + √âcriture)</option>
                </select>
            </div>

            <div class="section">
                <h3>‚öôÔ∏è Options</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="host-mode">
                    <span>Mode H√¥te (Affichage seulement)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="distance-mode">
                    <span>Mode Distance (Son sur tous les appareils)</span>
                </label>
            </div>

            <div class="section">
                <h3>üî¢ Nombre de questions</h3>
                <div class="num-grid">
                    <button class="num-btn" onclick="selectNumQ(5)">5</button>
                    <button class="num-btn active" onclick="selectNumQ(10)">10</button>
                    <button class="num-btn" onclick="selectNumQ(15)">15</button>
                    <button class="num-btn" onclick="selectNumQ(20)">20</button>
                    <button class="num-btn" onclick="selectNumQ(30)">30</button>
                </div>
            </div>

            <div class="section">
                <h3>üéµ Choisir une playlist</h3>
                <select id="playlist-select" class="select">
                    <option value="">-- S√©lectionner --</option>
                </select>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #aaa;">
                    Ou ajouter une URL personnalis√©e :
                </p>
                <input id="custom-playlist-url" class="input" placeholder="URL Playlist Deezer">
                <button class="btn large" onclick="loadAndCreate()">üöÄ Cr√©er la partie</button>
            </div>

            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- JOIN -->
        <div id="join-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üë• Rejoindre</h2>
            <input id="join-name" class="input" placeholder="Ton pseudo" maxlength="20">
            <input id="join-code" class="input code-input" placeholder="123456" type="tel" maxlength="6">
            <button class="btn large" onclick="joinRoom()">‚ñ∂Ô∏è Rejoindre</button>
            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- LOBBY -->
        <div id="lobby-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">Salle d'attente</h2>
            
            <div class="code-display">
                <div class="code-label">Code de la partie</div>
                <div class="code-value" id="lobby-code">000000</div>
            </div>

            <div class="players-box">
                <h3>üë• Joueurs (<span id="player-count">0</span>)</h3>
                <div id="players-list"></div>
            </div>

            <button id="start-btn" class="btn large hidden" onclick="startGame()">‚ñ∂Ô∏è Lancer la partie</button>
            <div id="waiting-div" class="waiting hidden">
                <div class="spinner"></div>
                <p>En attente de l'h√¥te...</p>
            </div>
        </div>

        <!-- GAME -->
        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                <div class="timer">‚è±Ô∏è <span id="timer">20</span>s</div>
                <div>Q <span id="current-q">1</span>/<span id="total-q">10</span></div>
                <div class="score">üèÜ <span id="player-score">0</span></div>
            </div>

            <div class="game-container">
                <!-- SCOREBOARD TEMPS R√âEL -->
                <div id="scoreboard-side" class="scoreboard-side">
                    <h3>üèÜ Scores</h3>
                    <div id="live-scores"></div>
                </div>

                <!-- GAME PRINCIPAL -->
                <div class="game-main">
                    <div class="img-box">
                        <img id="cover-img" class="cover" src="" alt="Cover">
                        <div id="answer-reveal" class="answer-reveal hidden">
                            <h4>R√©ponse :</h4>
                            <div class="answer-text" id="answer-text"></div>
                        </div>
                    </div>

                    <div id="audio-box" class="audio-box hidden">
                        <audio id="audio-player" loop></audio>
                        <button class="audio-btn" onclick="toggleAudio()">üéµ Play</button>
                    </div>

                    <div class="question-box">
                        <h3 id="question-text" class="q-text"></h3>
                        <div id="options-container" class="options hidden"></div>
                        <div id="writing-container" class="hidden">
                            <input id="input-title" class="input" placeholder="Titre">
                            <input id="input-artist" class="input" placeholder="Artiste">
                            <button class="btn" onclick="submitWriting()">Valider</button>
                        </div>
                        <div id="result-container" class="result hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD -->
        <div id="leaderboard-screen" class="screen hidden">
            <h1 class="leaderboard-title">üèÜ CLASSEMENT FINAL üèÜ</h1>
            <div id="podium-container" class="podium"></div>
            <div id="leaderboard-container" class="leaderboard"></div>
            <button class="btn large" onclick="restartGame()">üè† Nouvelle partie</button>
        </div>

        <!-- BOUTON SECOURS -->
        <button id="emergency-btn" class="emergency-btn hidden" onclick="emergencyReset()">üè† MENU</button>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ===========================================
        // CONFIG (√Ä d√©placer dans variables d'environnement pour production)
        // ===========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAWA-Zfs_hljCFz1wc0Rg2LJWZPINWONnU",
            authDomain: "quizz-party-ptg.firebaseapp.com",
            databaseURL: "https://quizz-party-ptg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quizz-party-ptg",
            storageBucket: "quizz-party-ptg.firebasestorage.app",
            messagingSenderId: "352511986737",
            appId: "1:352511986737:web:7318d807b4d3f3b6b29910"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        // ===========================================
        // √âTAT GLOBAL
        // ===========================================
        let currentScreen = 'menu';
        let gameState = {
            room: null,
            playerIndex: 0,
            isHost: false,
            numQuestions: 10,
            musicDB: [],
            currentTime: 20,
            timerInterval: null,
            answered: false,
            roomRef: null,
            audioPlaying: false,
            hostDisplayOnly: false,
            distanceMode: false
        };

        // ===========================================
        // DEEZER API
        // ===========================================
        const proxies = ['', 'https://corsproxy.io/?', 'https://api.codetabs.com/v1/proxy?quest='];

        async function fetchWithProxy(url) {
            for (let i = 0; i < proxies.length; i++) {
                try {
                    const finalUrl = proxies[i] + encodeURIComponent(url);
                    const response = await fetch(finalUrl);
                    if (!response.ok) throw new Error('Erreur');
                    return await response.json();
                } catch (error) {
                    if (i === proxies.length - 1) throw error;
                }
            }
        }

        async function getDeezerPlaylist(id) {
            const data = await fetchWithProxy(`https://api.deezer.com/playlist/${id}`);
            return data.tracks.data
                .filter(t => t.preview && t.album && t.album.cover_big)
                .map(t => ({
                    title: t.title,
                    artist: t.artist.name,
                    cover: t.album.cover_big,
                    preview: t.preview
                }));
        }

        // Tester si une preview fonctionne
        async function testPreview(url) {
            return new Promise((resolve) => {
                const audio = new Audio(url);
                audio.addEventListener('canplaythrough', () => resolve(true), { once: true });
                audio.addEventListener('error', () => resolve(false), { once: true });
                audio.load();
                setTimeout(() => resolve(false), 3000); // Timeout 3s
            });
        }

        // Filtrer les musiques cass√©es
        async function filterWorkingTracks(tracks) {
            showLoading('Test des musiques...');
            const results = [];
            
            for (let i = 0; i < tracks.length; i++) {
                updateLoading(`Test ${i + 1}/${tracks.length}...`);
                const works = await testPreview(tracks[i].preview);
                if (works) {
                    results.push(tracks[i]);
                }
            }
            
            hideLoading();
            return results;
        }

        // ===========================================
        // UTILS
        // ===========================================
        function shuffle(arr) {
            return [...arr].sort(() => Math.random() - 0.5);
        }

        function genCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId.replace('-screen', '');
            
            const emergency = document.getElementById('emergency-btn');
            if (screenId === 'menu-screen' || screenId === 'leaderboard-screen') {
                emergency.classList.add('hidden');
            } else {
                emergency.classList.remove('hidden');
            }
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function updateLoading(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Fonction pour v√©rifier similarit√© (tol√©rance 1 lettre)
        function isSimilar(a, b) {
            a = a.toLowerCase().trim();
            b = b.toLowerCase().trim();
            
            if (a === b) return true;
            if (Math.abs(a.length - b.length) > 1) return false;
            
            let diff = 0;
            const maxLen = Math.max(a.length, b.length);
            
            for (let i = 0; i < maxLen; i++) {
                if (a[i] !== b[i]) diff++;
                if (diff > 1) return false;
            }
            
            return diff <= 1;
        }

        // ===========================================
        // NAVIGATION
        // ===========================================
        function goToMenu() {
            if (gameState.roomRef) gameState.roomRef.off();
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState = {
                room: null,
                playerIndex: 0,
                isHost: false,
                numQuestions: 10,
                musicDB: [],
                currentTime: 20,
                timerInterval: null,
                answered: false,
                roomRef: null,
                audioPlaying: false,
                hostDisplayOnly: false,
                distanceMode: false
            };
            showScreen('menu-screen');
        }

        function goToCreate() {
            loadPlaylistsSelect();
            showScreen('create-screen');
        }

        function goToJoin() {
            showScreen('join-screen');
        }

        function goToPlaylists() {
            loadPlaylists();
            showScreen('playlists-screen');
        }

        function emergencyReset() {
            if (confirm('Retour au menu ? La partie en cours sera perdue.')) {
                goToMenu();
            }
        }

        // ===========================================
        // PLAYLISTS
        // ===========================================
        async function loadPlaylists() {
            const snapshot = await db.ref('playlists').once('value');
            const playlists = snapshot.val() || {};
            
            const container = document.getElementById('playlists-list');
            container.innerHTML = '';
            
            if (Object.keys(playlists).length === 0) {
                container.innerHTML = '<p style="color: #aaa; text-align: center;">Aucune playlist enregistr√©e</p>';
                return;
            }
            
            Object.entries(playlists).forEach(([id, playlist]) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.innerHTML = `
                    <span class="playlist-name">${playlist.name}</span>
                    <span class="playlist-url">${playlist.url}</span>
                    <button class="btn danger" onclick="deletePlaylist('${id}')">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        async function loadPlaylistsSelect() {
            const snapshot = await db.ref('playlists').once('value');
            const playlists = snapshot.val() || {};
            
            const select = document.getElementById('playlist-select');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            
            Object.entries(playlists).forEach(([id, playlist]) => {
                const option = document.createElement('option');
                option.value = playlist.url;
                option.textContent = playlist.name;
                select.appendChild(option);
            });
        }

        function showAddPlaylist() {
            document.getElementById('add-playlist-form').classList.remove('hidden');
        }

        async function savePlaylist() {
            const name = document.getElementById('new-playlist-name').value.trim();
            const url = document.getElementById('new-playlist-url').value.trim();
            
            if (!name || !url) {
                alert('‚ö†Ô∏è Remplis tous les champs !');
                return;
            }
            
            const match = url.match(/playlist\/(\d+)/);
            if (!match) {
                alert('‚ùå URL Deezer invalide !');
                return;
            }
            
            await db.ref('playlists').push({
                name,
                url,
                createdAt: Date.now()
            });
            
            alert('‚úÖ Playlist enregistr√©e !');
            document.getElementById('new-playlist-name').value = '';
            document.getElementById('new-playlist-url').value = '';
            document.getElementById('add-playlist-form').classList.add('hidden');
            loadPlaylists();
        }

        async function deletePlaylist(id) {
            if (confirm('Supprimer cette playlist ?')) {
                await db.ref(`playlists/${id}`).remove();
                loadPlaylists();
            }
        }

        // ===========================================
        // CREATE
        // ===========================================
        function selectNumQ(num) {
            gameState.numQuestions = num;
            document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function loadAndCreate() {
            const name = document.getElementById('create-name').value.trim();
            const mode = document.getElementById('create-mode').value;
            const hostMode = document.getElementById('host-mode').checked;
            const distanceMode = document.getElementById('distance-mode').checked;
            
            let url = document.getElementById('playlist-select').value;
            if (!url) {
                url = document.getElementById('custom-playlist-url').value.trim();
            }
            
            if (!name) {
                alert('‚ö†Ô∏è Entre ton pseudo !');
                return;
            }
            
            if (!url) {
                alert('‚ö†Ô∏è Choisis une playlist !');
                return;
            }
            
            const match = url.match(/playlist\/(\d+)/);
            if (!match) {
                alert('‚ùå URL invalide !');
                return;
            }
            
            try {
                showLoading('Chargement des musiques...');
                let tracks = await getDeezerPlaylist(match[1]);
                
                showLoading(`${tracks.length} musiques charg√©es. Filtrage...`);
                tracks = await filterWorkingTracks(tracks);
                
                if (tracks.length < gameState.numQuestions) {
                    alert(`‚ö†Ô∏è Seulement ${tracks.length} musiques valides. Ajuste le nombre de questions.`);
                    hideLoading();
                    return;
                }
                
                alert(`‚úÖ ${tracks.length} musiques pr√™tes !`);
                hideLoading();
                
                createRoom(name, mode, tracks, hostMode, distanceMode);
            } catch (e) {
                hideLoading();
                alert('‚ùå Erreur : ' + e.message);
            }
        }

        function createRoom(name, mode, tracks, hostMode, distanceMode) {
            const code = genCode();
            
            gameState.musicDB = tracks;
            gameState.hostDisplayOnly = hostMode;
            gameState.distanceMode = distanceMode;
            
            const shuffled = shuffle(tracks);
            let questions;
            
            if (mode === 'soiree') {
                const half = Math.floor(gameState.numQuestions / 2);
                questions = [
                    ...shuffled.slice(0, half).map(q => ({
                        ...q,
                        type: 'qcm',
                        qType: Math.random() > 0.5 ? 'artist' : 'title'
                    })),
                    ...shuffled.slice(half, gameState.numQuestions).map(q => ({
                        ...q,
                        type: 'writing'
                    }))
                ];
            } else if (mode === 'qcm') {
                questions = shuffled.slice(0, gameState.numQuestions).map(q => ({
                    ...q,
                    type: 'qcm',
                    qType: Math.random() > 0.5 ? 'artist' : 'title'
                }));
            } else if (mode === 'title-only') {
                questions = shuffled.slice(0, gameState.numQuestions).map(q => ({
                    ...q,
                    type: 'qcm',
                    qType: 'title'
                }));
            } else {
                questions = shuffled.slice(0, gameState.numQuestions).map(q => ({
                    ...q,
                    type: mode
                }));
            }

            const room = {
                code,
                host: name,
                hostMode: hostMode,
                distanceMode: distanceMode,
                players: [{ name, score: 0, isHost: true }],
                questions,
                currentQ: 0,
                started: false
            };

            db.ref(`rooms/${code}`).set(room);
            
            gameState.room = room;
            gameState.playerIndex = 0;
            gameState.isHost = true;
            
            goToLobby();
        }

        // ===========================================
        // JOIN
        // ===========================================
        function joinRoom() {
            const name = document.getElementById('join-name').value.trim();
            const code = document.getElementById('join-code').value.trim();

            if (!name) { alert('‚ö†Ô∏è Entre ton pseudo !'); return; }
            if (code.length !== 6) { alert('‚ö†Ô∏è Code invalide !'); return; }

            db.ref(`rooms/${code}`).once('value', snapshot => {
                const room = snapshot.val();
                
                if (!room) { alert('‚ùå Code invalide !'); return; }
                if (room.started) { alert('‚ùå Partie d√©j√† lanc√©e !'); return; }

                room.players.push({ name, score: 0 });
                db.ref(`rooms/${code}`).update({ players: room.players });

                gameState.room = room;
                gameState.playerIndex = room.players.length - 1;
                gameState.isHost = false;
                gameState.distanceMode = room.distanceMode || false;
                gameState.musicDB = room.questions;

                goToLobby();
            });
        }

        // ===========================================
        // LOBBY
        // ===========================================
        function goToLobby() {
            showScreen('lobby-screen');
            
            document.getElementById('lobby-code').textContent = gameState.room.code;
            
            if (gameState.isHost) {
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('waiting-div').classList.add('hidden');
            } else {
                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('waiting-div').classList.remove('hidden');
            }

            updatePlayersList();
            listenToRoom();
        }

        function updatePlayersList() {
            const list = document.getElementById('players-list');
            const count = document.getElementById('player-count');
            
            list.innerHTML = '';
            count.textContent = gameState.room.players.length;
            
            gameState.room.players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'player';
                div.innerHTML = `
                    <span class="player-num">${i + 1}</span>
                    <span class="player-name">${p.name}</span>
                    ${p.name === gameState.room.host ? '<span>üëë</span>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function listenToRoom() {
            if (gameState.roomRef) gameState.roomRef.off();
            
            const ref = db.ref(`rooms/${gameState.room.code}`);
            gameState.roomRef = ref;

            ref.on('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;

                const oldCurrentQ = gameState.room ? gameState.room.currentQ : -1;
                gameState.room = data;

                if (currentScreen === 'lobby') {
                    updatePlayersList();
                    if (data.started) {
                        goToGame();
                    }
                }

                if (currentScreen === 'game') {
                    updateScoreboard();
                    
                    if (data.currentQ !== oldCurrentQ && data.currentQ < data.questions.length) {
                        console.log('üì¢ Nouvelle question:', data.currentQ);
                        loadQuestion();
                    }
                    
                    if (data.currentQ >= data.questions.length) {
                        console.log('üèÅ Fin du jeu !');
                        goToLeaderboard();
                    }
                }
            });
        }

        function startGame() {
            db.ref(`rooms/${gameState.room.code}`).update({ started: true });
        }

        // ===========================================
        // GAME
        // ===========================================
        function goToGame() {
            showScreen('game-screen');
            loadQuestion();
        }

        function loadQuestion() {
            const q = gameState.room.questions[gameState.room.currentQ];
            const player = gameState.room.players[gameState.playerIndex];

            gameState.currentTime = 20;
            gameState.answered = false;
            gameState.audioPlaying = false;

            document.getElementById('current-q').textContent = gameState.room.currentQ + 1;
            document.getElementById('total-q').textContent = gameState.room.questions.length;
            document.getElementById('player-score').textContent = player.score || 0;
            document.getElementById('timer').textContent = '20';
            
            document.getElementById('cover-img').src = q.cover;
            document.getElementById('cover-img').style.filter = 'blur(25px)';

            document.getElementById('answer-reveal').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');

            updateScoreboard();

            // Audio
            const audioBox = document.getElementById('audio-box');
            const audio = document.getElementById('audio-player');
            
            // MODE DISTANCE : Audio pour tout le monde
            // MODE NORMAL : Audio seulement pour l'h√¥te
            if (gameState.distanceMode || gameState.isHost) {
                audioBox.classList.remove('hidden');
                audio.src = q.preview;
                audio.load();
                
                setTimeout(() => {
                    audio.play()
                        .then(() => {
                            console.log('‚úÖ Audio lanc√©');
                            gameState.audioPlaying = true;
                        })
                        .catch(err => {
                            console.error('‚ùå Erreur audio:', err);
                        });
                }, 500);
            } else {
                audioBox.classList.add('hidden');
            }

            // MODE H√îTE : ne pas afficher les questions
            if (gameState.hostDisplayOnly) {
                document.getElementById('options-container').classList.add('hidden');
                document.getElementById('writing-container').classList.add('hidden');
                document.getElementById('question-text').textContent = 'üéÆ Mode Affichage';
                startTimer();
                return;
            }

            // Question normale
            if (q.type === 'qcm') {
                loadQCM(q);
            } else {
                loadWriting(q);
            }

            startTimer();
        }

        function updateScoreboard() {
            const container = document.getElementById('live-scores');
            const scoreboard = document.getElementById('scoreboard-side');
            
            // Scoreboard visible SEULEMENT pour l'h√¥te ET si pas en mode distance
            if (!gameState.isHost || gameState.distanceMode) {
                scoreboard.style.display = 'none';
                return;
            }
            
            scoreboard.style.display = 'block';
            container.innerHTML = '';

            const sorted = [...gameState.room.players].sort((a, b) => (b.score || 0) - (a.score || 0));

            sorted.forEach(p => {
                const div = document.createElement('div');
                div.className = 'score-item';
                if (p.name === gameState.room.players[gameState.playerIndex].name) {
                    div.classList.add('me');
                }
                div.innerHTML = `
                    <span class="score-name">${p.name}</span>
                    <span class="score-points">${p.score || 0}</span>
                `;
                container.appendChild(div);
            });
        }

        function loadQCM(q) {
            const type = q.qType || 'title';
            const correct = q[type];
            
            document.getElementById('question-text').textContent = 
                type === 'artist' ? "Qui est l'artiste ?" : "Quel est le titre ?";

            const allTracks = gameState.musicDB;
            const wrongPool = shuffle(allTracks.filter(t => t[type] !== correct));
            
            const options = [correct];
            while (options.length < 4 && wrongPool.length > 0) {
                const val = wrongPool.pop()[type];
                if (val && !options.includes(val)) {
                    options.push(val);
                }
            }

            const shuffledOptions = shuffle(options);

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('writing-container').classList.add('hidden');

            shuffledOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt';
                btn.textContent = opt;
                btn.onclick = () => submitQCM(opt, correct);
                container.appendChild(btn);
            });

            gameState.correctAnswer = correct;
        }

        function loadWriting(q) {
            document.getElementById('question-text').textContent = "√âcris le titre et l'artiste";
            document.getElementById('options-container').classList.add('hidden');
            document.getElementById('writing-container').classList.remove('hidden');
            document.getElementById('input-title').value = '';
            document.getElementById('input-artist').value = '';
        }

        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);

            gameState.timerInterval = setInterval(() => {
                gameState.currentTime--;
                document.getElementById('timer').textContent = gameState.currentTime;

                if (!gameState.answered) {
                    const blur = (gameState.currentTime / 20) * 25;
                    document.getElementById('cover-img').style.filter = `blur(${blur}px)`;
                }

                if (gameState.currentTime <= 0) {
                    clearInterval(gameState.timerInterval);
                    
                    document.getElementById('cover-img').style.filter = 'blur(0px)';
                    
                    const q = gameState.room.questions[gameState.room.currentQ];
                    document.getElementById('answer-text').textContent = `${q.title} - ${q.artist}`;
                    document.getElementById('answer-reveal').classList.remove('hidden');
                    
                    if (gameState.distanceMode || gameState.isHost) {
                        document.getElementById('audio-player').pause();
                    }

                    if (gameState.isHost && !gameState.answered) {
                        gameState.answered = true;
                    }
                    
                    setTimeout(() => {
                        if (gameState.isHost) {
                            db.ref(`rooms/${gameState.room.code}/currentQ`).once('value', snapshot => {
                                const currentQ = snapshot.val();
                                db.ref(`rooms/${gameState.room.code}/currentQ`).set(currentQ + 1);
                            });
                        }
                    }, 2500);
                }
            }, 1000);
        }

        function submitQCM(answer, correct) {
            if (gameState.answered) return;
            gameState.answered = true;

            const isCorrect = answer === correct;
            const pts = isCorrect ? (50 + gameState.currentTime * 10) : 0;
            
            document.querySelectorAll('.opt').forEach(btn => {
                btn.classList.add('disabled');
                btn.onclick = null;
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('wrong');
                }
            });

            showResult(isCorrect, pts, `${gameState.room.questions[gameState.room.currentQ].title} - ${gameState.room.questions[gameState.room.currentQ].artist}`);
            updateScore(pts);
        }

        function submitWriting() {
            if (gameState.answered) return;
            gameState.answered = true;

            const q = gameState.room.questions[gameState.room.currentQ];
            const titleInput = document.getElementById('input-title').value.toLowerCase().trim();
            const artistInput = document.getElementById('input-artist').value.toLowerCase().trim();

            const titleWords = q.title.toLowerCase().split(' ');
            const titleOk = titleWords.some(word => 
                word.length > 2 && (
                    titleInput.includes(word) || 
                    isSimilar(titleInput, word) ||
                    titleWords.join(' ').includes(titleInput)
                )
            );

            const artistNames = q.artist.toLowerCase()
                .replace(/ feat\.? /gi, ',')
                .replace(/ & /g, ',')
                .split(',')
                .map(a => a.trim());

            const artistOk = artistNames.some(artist => {
                const artistWords = artist.split(' ');
                return artistWords.some(word => 
                    word.length > 2 && (
                        artistInput.includes(word) || 
                        isSimilar(artistInput, word) ||
                        artist.includes(artistInput)
                    )
                );
            });

            let isCorrect = false;
            let pts = 0;
            let feedback = '';

            if (titleOk && artistOk) {
                isCorrect = true;
                pts = 50 + gameState.currentTime * 10;
                feedback = 'Parfait !';
            } else if (titleOk) {
                pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                feedback = 'Bon titre ! (50%)';
            } else if (artistOk) {
                pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                feedback = 'Bon artiste ! (50%)';
            }

            showResult(isCorrect || (titleOk || artistOk), pts, `${q.title} - ${q.artist}`, feedback);
            updateScore(pts);
        }

        function showResult(isCorrect, pts, answer, feedback = '') {
            const container = document.getElementById('result-container');
            container.classList.remove('hidden', 'correct', 'wrong');
            container.classList.add(isCorrect ? 'correct' : 'wrong');
            
            if (pts > 0) {
                container.textContent = `üéâ ${feedback} +${pts} pts`;
            } else {
                container.textContent = `‚ùå ${answer}`;
            }
        }

        function updateScore(pts) {
            const players = [...gameState.room.players];
            players[gameState.playerIndex].score = (players[gameState.playerIndex].score || 0) + pts;
            
            db.ref(`rooms/${gameState.room.code}/players`).set(players);
        }

        function toggleAudio() {
            const audio = document.getElementById('audio-player');
            const btn = event.target;
            
            if (audio.paused) {
                audio.play();
                btn.textContent = 'üéµ Stop';
            } else {
                audio.pause();
                btn.textContent = 'üéµ Play';
            }
        }

        // ===========================================
        // LEADERBOARD
        // ===========================================
        function goToLeaderboard() {
            console.log('üèÜ LEADERBOARD');
            
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            if (gameState.roomRef) gameState.roomRef.off();

            showScreen('leaderboard-screen');

            const players = gameState.room.players || [];
            const sorted = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));

            const podium = document.getElementById('podium-container');
            podium.innerHTML = '';
            
            sorted.slice(0, 3).forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'podium-item';
                div.innerHTML = `
                    <div class="medal">${['ü•á','ü•à','ü•â'][i]}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-score">${p.score || 0} pts</div>
                `;
                podium.appendChild(div);
            });

            const list = document.getElementById('leaderboard-container');
            list.innerHTML = '';
            
            sorted.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'lb-row';
                div.innerHTML = `
                    <span class="rank">#${i + 1}</span>
                    <span class="name">${p.name}</span>
                    <span class="pts">${p.score || 0} pts</span>
                `;
                list.appendChild(div);
            });
        }

        function restartGame() {
            goToMenu();
        }

        // ===========================================
        // INIT
        // ===========================================
        console.log('‚úÖ Quiz Party V1 charg√© !');
    </script>
</body>
</html>
