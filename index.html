<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Party üéµ</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #0a0e27;
            color: white;
            min-height: 100vh;
        }

        .app { min-height: 100vh; position: relative; }

        .bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 0, 110, 0.1), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(131, 56, 236, 0.1), transparent 50%);
            animation: pulse 8s infinite;
            z-index: 0;
        }

        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

        .screen {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hidden { display: none !important; }

        /* MENU */
        .logo { text-align: center; margin-bottom: 2rem; }
        .title {
            font-family: 'Bungee Shade', cursive;
            font-size: 4rem;
            background: linear-gradient(45deg, #ff006e, #00f5ff, #ffbe0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            font-size: 1.2rem;
            color: #00f5ff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            margin: 0.3rem;
        }

        .btn:hover:not(:disabled) { transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.large { padding: 1.5rem 3rem; font-size: 1.3rem; }
        .btn.secondary { background: linear-gradient(135deg, #00f5ff, #ffbe0b); }
        .btn.danger { background: linear-gradient(135deg, #ff006e, #ff4444); }

        /* INPUTS */
        .input, .select {
            width: 100%;
            max-width: 400px;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #8338ec;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .input:focus, .select:focus { outline: none; border-color: #ff006e; }
        .code-input { font-size: 2rem; text-align: center; letter-spacing: 0.5em; }

        /* SECTIONS */
        .section { margin: 1.5rem 0; text-align: center; width: 100%; max-width: 500px; }
        .section h3 { color: #00f5ff; margin-bottom: 1rem; }

        .num-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .num-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            color: white;
            padding: 0.8rem;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }

        .num-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .num-btn.active { background: linear-gradient(135deg, #ff006e, #8338ec); border-color: #ff006e; }

        /* CHECKBOX */
        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            margin: 0.5rem 0;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .checkbox-label:hover { background: rgba(0, 0, 0, 0.4); }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label span {
            color: #00f5ff;
            font-weight: 600;
        }

        /* PLAYLISTS */
        .playlists-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 1rem 0;
        }

        .playlist-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .playlist-name {
            flex: 1;
            font-weight: 600;
            color: #ffbe0b;
        }

        .playlist-url {
            flex: 2;
            font-size: 0.8rem;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* LOBBY */
        .code-display {
            text-align: center;
            background: linear-gradient(135deg, #1a1f3a, #2a2f4a);
            border: 3px solid #ffbe0b;
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(255, 190, 11, 0.3);
        }

        .code-label { color: #aaa; font-size: 1rem; margin-bottom: 1rem; }
        .code-value {
            font-size: 5rem;
            font-weight: 800;
            color: #ffbe0b;
            letter-spacing: 0.3em;
            text-shadow: 0 0 30px rgba(255, 190, 11, 0.6);
        }

        .players-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin: 1rem 0;
        }

        .player-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #00f5ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name { flex: 1; }
        .player-score { color: #ffbe0b; font-size: 1.1rem; }

        /* GAME */
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        .info-item { text-align: center; flex: 1; }
        .info-label { color: #aaa; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .info-value { font-size: 2rem; font-weight: 800; }

        #timer { color: #ff006e; }
        #question-num { color: #00f5ff; }
        #score { color: #ffbe0b; }

        .album-cover {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 2rem auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.5s;
        }

        .question-box {
            text-align: center;
            margin: 2rem 0;
            width: 100%;
            max-width: 800px;
        }

        #question-text {
            font-size: 1.8rem;
            font-weight: 800;
            color: #00f5ff;
            margin-bottom: 2rem;
        }

        #options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .opt {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            color: white;
            padding: 1.2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
        }

        .opt:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .opt.disabled { cursor: not-allowed; opacity: 0.6; }
        .opt.correct { background: linear-gradient(135deg, #00f5a0, #00d9ff); border-color: #00f5a0; }
        .opt.wrong { background: linear-gradient(135deg, #ff006e, #ff4444); border-color: #ff006e; }

        #writing-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        #writing-container .input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8338ec;
        }

        #result-container {
            margin-top: 2rem;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
        }

        #result-container.correct {
            background: linear-gradient(135deg, #00f5a0, #00d9ff);
            color: #0a0e27;
        }

        #result-container.wrong {
            background: linear-gradient(135deg, #ff006e, #ff4444);
            color: white;
        }

        #answer-reveal {
            margin-top: 2rem;
            padding: 1.5rem 2rem;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffbe0b;
            border-radius: 15px;
            text-align: center;
        }

        #answer-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: #ffbe0b;
        }

        /* LEADERBOARD */
        #podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .podium-item {
            background: linear-gradient(135deg, #1a1f3a, #2a2f4a);
            border: 3px solid;
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            min-width: 180px;
        }

        .podium-item:nth-child(1) {
            border-color: #ffbe0b;
            order: 2;
            min-height: 250px;
        }

        .podium-item:nth-child(2) {
            border-color: #c0c0c0;
            order: 1;
            min-height: 200px;
        }

        .podium-item:nth-child(3) {
            border-color: #cd7f32;
            order: 3;
            min-height: 180px;
        }

        .medal { font-size: 3rem; margin-bottom: 1rem; }
        .p-name { font-size: 1.2rem; font-weight: 800; color: #00f5ff; margin-bottom: 0.5rem; }
        .p-score { font-size: 1.5rem; font-weight: 800; color: #ffbe0b; }

        #leaderboard-container {
            width: 100%;
            max-width: 600px;
            margin: 2rem 0;
        }

        .lb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .rank { color: #aaa; font-weight: 800; width: 50px; }
        .name { flex: 1; font-weight: 600; color: #00f5ff; }
        .pts { color: #ffbe0b; font-weight: 800; }

        /* LEVEL TRANSITION */
        .level-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #8338ec, #ff006e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .level-transition h1 {
            font-size: 5rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.5);
            margin-bottom: 1rem;
            animation: scaleIn 0.5s;
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); }
            to { transform: scale(1); }
        }

        .level-transition p {
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.9);
        }

        /* ALL-TIME LEADERBOARD */
        .leaderboard-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            color: white;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            border-color: #ff006e;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        #alltime-container {
            width: 100%;
            max-width: 600px;
            margin: 2rem 0;
        }

        .alltime-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            border-left: 4px solid;
        }

        .alltime-row:nth-child(1) { border-left-color: #ffbe0b; }
        .alltime-row:nth-child(2) { border-left-color: #c0c0c0; }
        .alltime-row:nth-child(3) { border-left-color: #cd7f32; }
        .alltime-row:nth-child(n+4) { border-left-color: #8338ec; }

        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .subtitle { font-size: 0.9rem; }
            .code-value { font-size: 3rem; }
            #options-container { grid-template-columns: 1fr; }
            .album-cover { width: 250px; height: 250px; }
        }
    </style>
</head>
<body>
    <div class="bg"></div>
    <div class="app">
        <!-- MENU PRINCIPAL -->
        <div id="menu-screen" class="screen">
            <div class="logo">
                <h1 class="title">QUIZ PARTY</h1>
                <p class="subtitle">Blind Test Musical</p>
            </div>
            <div class="menu-buttons">
                <button class="btn large" onclick="goToHost()">üéÆ Cr√©er une partie</button>
                <button class="btn large secondary" onclick="goToJoin()">üéØ Rejoindre</button>
            </div>
        </div>

        <!-- CR√âER UNE PARTIE (H√îTE) -->
        <div id="host-screen" class="screen hidden">
            <h2 style="color: #00f5ff; margin-bottom: 2rem; font-size: 2rem;">üéÆ Configuration de la partie</h2>

            <div class="section">
                <h3>üë§ Ton pseudo</h3>
                <input type="text" id="host-name" class="input" placeholder="Entre ton pseudo" maxlength="20">
            </div>

            <div class="section">
                <h3>üéµ Nombre de questions</h3>
                <div class="num-grid" id="num-questions-grid"></div>
            </div>

            <div class="section">
                <h3>üéÆ Mode de jeu</h3>
                <select id="game-mode" class="select">
                    <option value="qcm">QCM</option>
                    <option value="writing">√âcriture</option>
                    <option value="party">Soir√©e (Mix)</option>
                </select>
            </div>

            <div class="section">
                <label class="checkbox-label">
                    <input type="checkbox" id="distance-mode">
                    <span>üåç Mode Distance (chacun √©coute de son c√¥t√©)</span>
                </label>
            </div>

            <div class="section">
                <h3>üìã Playlists Spotify</h3>
                <input type="text" id="playlist-name" class="input" placeholder="Nom de la playlist">
                <input type="text" id="playlist-url" class="input" placeholder="URL Spotify">
                <button class="btn secondary" onclick="addPlaylist()">‚ûï Ajouter</button>
            </div>

            <div class="playlists-box" id="playlists-list"></div>

            <button class="btn large" onclick="createRoom()" id="create-room-btn" disabled>üöÄ Lancer la partie</button>
            <button class="btn" onclick="goToMenu()">‚Üê Retour</button>
        </div>

        <!-- REJOINDRE UNE PARTIE -->
        <div id="join-screen" class="screen hidden">
            <h2 style="color: #00f5ff; margin-bottom: 2rem; font-size: 2rem;">üéØ Rejoindre une partie</h2>
            
            <input type="text" id="player-name" class="input" placeholder="Entre ton pseudo" maxlength="20">
            <input type="text" id="room-code" class="input code-input" placeholder="CODE" maxlength="4" style="text-transform: uppercase;">
            
            <button class="btn large" onclick="joinRoom()">‚úÖ Rejoindre</button>
            <button class="btn" onclick="goToMenu()">‚Üê Retour</button>
        </div>

        <!-- LOBBY (ATTENTE) -->
        <div id="lobby-screen" class="screen hidden">
            <div class="code-display">
                <p class="code-label">Code de la partie</p>
                <p class="code-value" id="room-code-display">----</p>
            </div>

            <div class="players-box">
                <h3 style="color: #00f5ff; margin-bottom: 1rem; text-align: center;">üë• Joueurs connect√©s</h3>
                <div id="players-list"></div>
            </div>

            <button class="btn large" id="start-game-btn" onclick="startGame()" style="display: none;">üéÆ D√©marrer le jeu</button>
            <button class="btn danger" onclick="leaveRoom()">‚ùå Quitter</button>
        </div>

        <!-- JEU -->
        <div id="game-screen" class="screen hidden">
            <div class="game-info">
                <div class="info-item">
                    <p class="info-label">Temps</p>
                    <p class="info-value" id="timer">20</p>
                </div>
                <div class="info-item">
                    <p class="info-label">Question</p>
                    <p class="info-value" id="question-num">1/10</p>
                </div>
                <div class="info-item">
                    <p class="info-label">Score</p>
                    <p class="info-value" id="score">0</p>
                </div>
            </div>

            <div class="album-cover" id="cover-container">
                <img id="cover-img" src="" alt="Cover">
            </div>

            <audio id="audio-player" style="display: none;"></audio>
            
            <button class="btn" onclick="toggleAudio()" id="audio-toggle-btn" style="display: none;">üéµ Play</button>

            <div class="question-box">
                <p id="question-text">Quel est ce titre ?</p>
                
                <div id="options-container" class="hidden"></div>

                <div id="writing-container" class="hidden">
                    <input type="text" id="input-artist" class="input" placeholder="Artiste">
                    <input type="text" id="input-title" class="input" placeholder="Titre">
                    <input type="number" id="input-year" class="input hidden" placeholder="Ann√©e de sortie">
                    <button class="btn large" onclick="submitWriting()">‚úÖ Valider</button>
                </div>

                <div id="result-container" class="hidden"></div>
                <div id="answer-reveal" class="hidden">
                    <p id="answer-text"></p>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD -->
        <div id="leaderboard-screen" class="screen hidden">
            <h2 style="color: #00f5ff; margin-bottom: 2rem; font-size: 2.5rem;">üèÜ Classement</h2>

            <div class="leaderboard-tabs">
                <button class="tab-btn active" onclick="switchLeaderboardTab('game')">Cette partie</button>
                <button class="tab-btn" onclick="switchLeaderboardTab('alltime')">Tous les temps</button>
            </div>

            <div id="game-leaderboard">
                <div id="podium-container"></div>
                <div id="leaderboard-container"></div>
            </div>

            <div id="alltime-leaderboard" class="hidden">
                <div id="alltime-container"></div>
            </div>

            <button class="btn large" onclick="restartGame()">üîÑ Nouvelle partie</button>
        </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ===========================================
        // FIREBASE CONFIG
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAQTbZe3gqS5d0YGb6_kT5OYZLgBnKlLHU",
            authDomain: "quiz-party-7eab2.firebaseapp.com",
            databaseURL: "https://quiz-party-7eab2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quiz-party-7eab2",
            storageBucket: "quiz-party-7eab2.firebasestorage.app",
            messagingSenderId: "878623844089",
            appId: "1:878623844089:web:db28e9d7d39c2bac42bdb7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===========================================
        // STATE
        // ===========================================
        const gameState = {
            playlists: [],
            room: null,
            playerIndex: -1,
            isHost: false,
            distanceMode: false,
            currentTime: 20,
            timerInterval: null,
            roomRef: null,
            answered: false,
            correctAnswer: '',
            usedArtistsForOptions: [], // Pour √©viter de r√©p√©ter les m√™mes artistes
            currentLevel: 1,
            questionsPerLevel: [],
            autoCheckInterval: null // Pour la d√©tection automatique en mode √©criture
        };

        // ===========================================
        // SCREENS
        // ===========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function goToMenu() {
            if (gameState.roomRef) {
                gameState.roomRef.off();
                gameState.roomRef = null;
            }
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            if (gameState.autoCheckInterval) {
                clearInterval(gameState.autoCheckInterval);
            }
            gameState.room = null;
            gameState.playerIndex = -1;
            gameState.isHost = false;
            gameState.usedArtistsForOptions = [];
            showScreen('menu-screen');
        }

        function goToHost() {
            showScreen('host-screen');
            renderNumGrid();
        }

        function goToJoin() {
            showScreen('join-screen');
        }

        // ===========================================
        // NUM GRID
        // ===========================================
        function renderNumGrid() {
            const grid = document.getElementById('num-questions-grid');
            grid.innerHTML = '';
            for (let i = 5; i <= 50; i += 5) {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.textContent = i;
                btn.onclick = () => selectNumQuestions(i, btn);
                grid.appendChild(btn);
            }
        }

        function selectNumQuestions(num, btn) {
            document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            gameState.numQuestions = num;
            updateCreateButton();
        }

        // ===========================================
        // PLAYLISTS
        // ===========================================
        function addPlaylist() {
            const name = document.getElementById('playlist-name').value.trim();
            const url = document.getElementById('playlist-url').value.trim();

            if (!name || !url) {
                alert('‚ö†Ô∏è Remplis le nom et l\'URL !');
                return;
            }

            if (!url.includes('spotify.com/playlist/')) {
                alert('‚ö†Ô∏è URL Spotify invalide !');
                return;
            }

            gameState.playlists.push({ name, url });
            document.getElementById('playlist-name').value = '';
            document.getElementById('playlist-url').value = '';
            renderPlaylists();
            updateCreateButton();
        }

        function renderPlaylists() {
            const container = document.getElementById('playlists-list');
            if (gameState.playlists.length === 0) {
                container.innerHTML = '<p style="color: #aaa; text-align: center;">Aucune playlist ajout√©e</p>';
                return;
            }

            container.innerHTML = gameState.playlists.map((p, i) => `
                <div class="playlist-item">
                    <span class="playlist-name">${p.name}</span>
                    <span class="playlist-url">${p.url}</span>
                    <button class="btn danger" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="removePlaylist(${i})">‚ùå</button>
                </div>
            `).join('');
        }

        function removePlaylist(index) {
            gameState.playlists.splice(index, 1);
            renderPlaylists();
            updateCreateButton();
        }

        function updateCreateButton() {
            const btn = document.getElementById('create-room-btn');
            btn.disabled = !(gameState.numQuestions && gameState.playlists.length > 0);
        }

        // ===========================================
        // CREATE ROOM
        // ===========================================
        async function createRoom() {
            const hostName = document.getElementById('host-name').value.trim();
            if (!hostName) {
                alert('‚ö†Ô∏è Entre ton pseudo !');
                return;
            }

            const gameMode = document.getElementById('game-mode').value;
            const distanceMode = document.getElementById('distance-mode').checked;

            const code = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            console.log('üéÆ Cr√©ation de la room:', code);

            try {
                const questions = await fetchQuestions();
                
                if (questions.length < gameState.numQuestions) {
                    alert(`‚ö†Ô∏è Pas assez de questions trouv√©es (${questions.length}/${gameState.numQuestions})`);
                    return;
                }

                const room = {
                    code,
                    host: hostName,
                    players: [{ name: hostName, score: 0 }],
                    questions: questions.slice(0, gameState.numQuestions),
                    gameMode,
                    distanceMode,
                    currentQ: 0,
                    started: false
                };

                await db.ref(`rooms/${code}`).set(room);

                gameState.room = room;
                gameState.isHost = true;
                gameState.distanceMode = distanceMode;
                gameState.playerIndex = 0;

                listenToRoom(code);
                showScreen('lobby-screen');
                document.getElementById('room-code-display').textContent = code;
                document.getElementById('start-game-btn').style.display = 'block';
            } catch (error) {
                console.error('‚ùå Erreur cr√©ation room:', error);
                alert('‚ùå Erreur lors de la cr√©ation de la partie');
            }
        }

        // ===========================================
        // FETCH QUESTIONS
        // ===========================================
        async function fetchQuestions() {
            console.log('üéµ R√©cup√©ration des questions...');
            
            const allTracks = [];
            
            for (const playlist of gameState.playlists) {
                const playlistId = playlist.url.split('/playlist/')[1].split('?')[0];
                const embedUrl = `https://open.spotify.com/embed/playlist/${playlistId}`;
                
                try {
                    const response = await fetch(embedUrl);
                    const html = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const scripts = doc.querySelectorAll('script');
                    
                    scripts.forEach(script => {
                        const content = script.textContent;
                        if (content.includes('"tracks"')) {
                            try {
                                const jsonMatch = content.match(/\{.*"tracks".*\}/s);
                                if (jsonMatch) {
                                    const data = JSON.parse(jsonMatch[0]);
                                    if (data.tracks && data.tracks.items) {
                                        data.tracks.items.forEach(item => {
                                            if (item.track) {
                                                const track = item.track;
                                                allTracks.push({
                                                    title: track.name,
                                                    artist: track.artists.map(a => a.name).join(', '),
                                                    preview: track.preview_url || '',
                                                    cover: track.album.images[0]?.url || '',
                                                    year: track.album.release_date ? new Date(track.album.release_date).getFullYear() : null
                                                });
                                            }
                                        });
                                    }
                                }
                            } catch (e) {
                                console.warn('Erreur parsing JSON:', e);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Erreur fetch playlist:', error);
                }
            }
            
            const validTracks = allTracks.filter(t => t.preview && t.cover);
            console.log(`‚úÖ ${validTracks.length} questions valides trouv√©es`);
            
            return shuffle(validTracks);
        }

        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // ===========================================
        // JOIN ROOM
        // ===========================================
        async function joinRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            const code = document.getElementById('room-code').value.trim().toUpperCase();

            if (!playerName || !code) {
                alert('‚ö†Ô∏è Remplis tous les champs !');
                return;
            }

            console.log('üéØ Tentative de rejoindre:', code);

            try {
                const snapshot = await db.ref(`rooms/${code}`).once('value');
                const room = snapshot.val();

                if (!room) {
                    alert('‚ùå Code invalide !');
                    return;
                }

                if (room.started) {
                    alert('‚ö†Ô∏è La partie a d√©j√† commenc√© !');
                    return;
                }

                const players = room.players || [];
                
                if (players.some(p => p.name === playerName)) {
                    alert('‚ö†Ô∏è Ce pseudo est d√©j√† pris !');
                    return;
                }

                players.push({ name: playerName, score: 0 });
                await db.ref(`rooms/${code}/players`).set(players);

                gameState.room = room;
                gameState.playerIndex = players.length - 1;
                gameState.isHost = false;
                gameState.distanceMode = room.distanceMode;

                listenToRoom(code);
                showScreen('lobby-screen');
                document.getElementById('room-code-display').textContent = code;
            } catch (error) {
                console.error('‚ùå Erreur join:', error);
                alert('‚ùå Erreur lors de la connexion');
            }
        }

        // ===========================================
        // LISTEN TO ROOM
        // ===========================================
        function listenToRoom(code) {
            gameState.roomRef = db.ref(`rooms/${code}`);
            
            gameState.roomRef.on('value', snapshot => {
                const room = snapshot.val();
                
                if (!room) {
                    alert('‚ùå La partie a √©t√© ferm√©e');
                    goToMenu();
                    return;
                }

                gameState.room = room;
                
                if (room.started && document.getElementById('lobby-screen').classList.contains('hidden') === false) {
                    // Calculer la distribution des questions par niveau
                    calculateQuestionsPerLevel(room.gameMode, room.questions.length);
                    showScreen('game-screen');
                    loadQuestion();
                }
                
                if (!room.started) {
                    renderPlayers();
                }
                
                if (room.currentQ !== undefined && room.started) {
                    if (room.currentQ >= room.questions.length) {
                        goToLeaderboard();
                    } else if (room.currentQ !== gameState.currentQIndex) {
                        gameState.currentQIndex = room.currentQ;
                        loadQuestion();
                    }
                }
            });
        }

        function renderPlayers() {
            const container = document.getElementById('players-list');
            const players = gameState.room?.players || [];
            
            if (players.length === 0) {
                container.innerHTML = '<p style="color: #aaa; text-align: center;">Aucun joueur</p>';
                return;
            }

            container.innerHTML = players.map((p, i) => `
                <div class="player-item">
                    <span class="player-name">${i === 0 ? 'üëë ' : ''}${p.name}</span>
                    <span class="player-score">${p.score || 0} pts</span>
                </div>
            `).join('');
        }

        function leaveRoom() {
            if (gameState.isHost) {
                if (confirm('‚ö†Ô∏è En tant qu\'h√¥te, quitter fermera la partie pour tous. Continuer ?')) {
                    db.ref(`rooms/${gameState.room.code}`).remove();
                    goToMenu();
                }
            } else {
                const players = [...gameState.room.players];
                players.splice(gameState.playerIndex, 1);
                db.ref(`rooms/${gameState.room.code}/players`).set(players);
                goToMenu();
            }
        }

        // ===========================================
        // CALCULATE QUESTIONS PER LEVEL
        // ===========================================
        function calculateQuestionsPerLevel(gameMode, totalQuestions) {
            gameState.questionsPerLevel = [];
            
            if (gameMode === 'party') {
                // Mode soir√©e : 3 modes, prioriser niveau 2
                const questionsPerMode = Math.floor(totalQuestions / 3);
                
                for (let mode of ['qcm', 'writing', 'qcm']) { // On alterne pour remplir
                    const l1 = Math.floor(questionsPerMode * 0.25);
                    const l3 = Math.floor(questionsPerMode * 0.25);
                    const l2 = questionsPerMode - l1 - l3;
                    
                    for (let i = 0; i < l1; i++) gameState.questionsPerLevel.push({ mode, level: 1 });
                    for (let i = 0; i < l2; i++) gameState.questionsPerLevel.push({ mode, level: 2 });
                    for (let i = 0; i < l3; i++) gameState.questionsPerLevel.push({ mode, level: 3 });
                }
                
                // Ajuster pour atteindre exactement totalQuestions
                while (gameState.questionsPerLevel.length < totalQuestions) {
                    gameState.questionsPerLevel.push({ mode: 'qcm', level: 2 });
                }
                gameState.questionsPerLevel = gameState.questionsPerLevel.slice(0, totalQuestions);
                
            } else {
                // Mode unique : QCM ou √âcriture
                const l1 = Math.floor(totalQuestions * 0.25);
                const l3 = Math.floor(totalQuestions * 0.25);
                const l2 = totalQuestions - l1 - l3;
                
                for (let i = 0; i < l1; i++) gameState.questionsPerLevel.push({ mode: gameMode, level: 1 });
                for (let i = 0; i < l2; i++) gameState.questionsPerLevel.push({ mode: gameMode, level: 2 });
                for (let i = 0; i < l3; i++) gameState.questionsPerLevel.push({ mode: gameMode, level: 3 });
            }
        }

        // ===========================================
        // START GAME
        // ===========================================
        function startGame() {
            if (!gameState.isHost) return;
            
            console.log('üöÄ D√©marrage du jeu');
            
            db.ref(`rooms/${gameState.room.code}/started`).set(true);
        }

        // ===========================================
        // LOAD QUESTION
        // ===========================================
        function loadQuestion() {
            console.log('üìù Chargement question', gameState.room.currentQ);
            
            const q = gameState.room.questions[gameState.room.currentQ];
            const currentQuestionConfig = gameState.questionsPerLevel[gameState.room.currentQ];
            
            // V√©rifier si on change de niveau
            const previousConfig = gameState.room.currentQ > 0 ? 
                gameState.questionsPerLevel[gameState.room.currentQ - 1] : null;
            
            if (previousConfig && 
                (previousConfig.level !== currentQuestionConfig.level || 
                 previousConfig.mode !== currentQuestionConfig.mode)) {
                showLevelTransition(currentQuestionConfig.level, currentQuestionConfig.mode);
            }
            
            gameState.currentLevel = currentQuestionConfig.level;
            gameState.currentMode = currentQuestionConfig.mode;
            gameState.answered = false;
            gameState.currentTime = 20;
            
            document.getElementById('question-num').textContent = 
                `${gameState.room.currentQ + 1}/${gameState.room.questions.length}`;
            document.getElementById('score').textContent = 
                gameState.room.players[gameState.playerIndex].score || 0;
            document.getElementById('timer').textContent = gameState.currentTime;
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('answer-reveal').classList.add('hidden');
            
            // Cover - masquer pour les non-h√¥tes en mode distance
            const coverContainer = document.getElementById('cover-container');
            if (gameState.distanceMode && !gameState.isHost) {
                coverContainer.style.display = 'none';
            } else {
                coverContainer.style.display = 'block';
                document.getElementById('cover-img').src = q.cover;
                document.getElementById('cover-img').style.filter = 'blur(25px)';
            }
            
            // Audio
            const audio = document.getElementById('audio-player');
            const audioToggleBtn = document.getElementById('audio-toggle-btn');
            
            if (gameState.distanceMode) {
                audio.src = q.preview;
                audioToggleBtn.style.display = 'block';
                audioToggleBtn.textContent = 'üéµ Play';
                audio.pause();
            } else if (gameState.isHost) {
                audio.src = q.preview;
                audio.currentTime = 0;
                
                // Pr√©charger l'audio pour r√©duire le d√©calage
                audio.load();
                audio.addEventListener('canplaythrough', function playWhenReady() {
                    audio.play();
                    audio.removeEventListener('canplaythrough', playWhenReady);
                }, { once: true });
                
                audioToggleBtn.style.display = 'none';
            } else {
                audioToggleBtn.style.display = 'none';
            }
            
            // Charger le bon mode selon le niveau
            if (currentQuestionConfig.mode === 'qcm') {
                loadQCM(q, currentQuestionConfig.level);
            } else {
                loadWriting(q, currentQuestionConfig.level);
            }
            
            startTimer();
        }

        // ===========================================
        // LEVEL TRANSITION
        // ===========================================
        function showLevelTransition(level, mode) {
            const transition = document.createElement('div');
            transition.className = 'level-transition';
            
            const modeText = mode === 'qcm' ? 'QCM' : '√âCRITURE';
            const levelText = `NIVEAU ${level}`;
            
            transition.innerHTML = `
                <h1>${levelText}</h1>
                <p>${modeText}</p>
            `;
            
            document.body.appendChild(transition);
            
            setTimeout(() => {
                transition.remove();
            }, 2000);
        }

        // ===========================================
        // QCM
        // ===========================================
        function loadQCM(q, level) {
            let questionText = '';
            let options = [];
            let correct = '';
            
            if (level === 1) {
                // Niveau 1 : 2 propositions d'artistes
                questionText = "Qui chante ce titre ?";
                correct = q.artist;
                options = getRandomOptions(q, 'artist', 1, level);
                options.push(correct);
                
            } else if (level === 2) {
                // Niveau 2 : 4 propositions d'artistes
                questionText = "Qui chante ce titre ?";
                correct = q.artist;
                options = getRandomOptions(q, 'artist', 3, level);
                options.push(correct);
                
            } else {
                // Niveau 3 : 4 orthographes diff√©rentes de l'artiste
                questionText = "Quelle est la bonne orthographe ?";
                correct = q.artist;
                options = generateSpellingVariants(q.artist);
                options.push(correct);
            }
            
            document.getElementById('question-text').textContent = questionText;

            const shuffledOptions = shuffle(options);

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('writing-container').classList.add('hidden');

            shuffledOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt';
                btn.textContent = opt;
                btn.onclick = () => submitQCM(opt, correct);
                container.appendChild(btn);
            });

            gameState.correctAnswer = correct;
        }

        function getRandomOptions(currentQ, field, count, level) {
            const allQuestions = gameState.room.questions;
            const options = [];
            const attempts = [];
            
            // Filtrer les questions qui ne sont pas la question actuelle
            let availableQuestions = allQuestions.filter(q => 
                q[field] !== currentQ[field]
            );
            
            // √âviter les artistes d√©j√† utilis√©s r√©cemment
            availableQuestions = availableQuestions.filter(q => 
                !gameState.usedArtistsForOptions.includes(q[field])
            );
            
            // Si on n'a plus assez d'options, r√©initialiser la liste des artistes utilis√©s
            if (availableQuestions.length < count) {
                gameState.usedArtistsForOptions = [];
                availableQuestions = allQuestions.filter(q => q[field] !== currentQ[field]);
            }
            
            // M√©langer vraiment al√©atoirement
            const shuffled = shuffle(availableQuestions);
            
            // Prendre les premi√®res options uniques
            const usedValues = new Set();
            for (const q of shuffled) {
                if (!usedValues.has(q[field]) && options.length < count) {
                    options.push(q[field]);
                    usedValues.add(q[field]);
                    gameState.usedArtistsForOptions.push(q[field]);
                    
                    // Limiter la taille de l'historique
                    if (gameState.usedArtistsForOptions.length > 20) {
                        gameState.usedArtistsForOptions.shift();
                    }
                }
                if (options.length >= count) break;
            }
            
            return options;
        }

        function generateSpellingVariants(artist) {
            // G√©n√©rer 3 variantes incorrectes de l'orthographe
            const variants = [];
            const original = artist;
            
            // Variante 1 : Changer la casse
            variants.push(original.toUpperCase());
            
            // Variante 2 : Ajouter/retirer des espaces ou tirets
            if (original.includes(' ')) {
                variants.push(original.replace(/ /g, '-'));
            } else {
                variants.push(original.replace(/-/g, ' '));
            }
            
            // Variante 3 : Inverser deux lettres
            if (original.length > 3) {
                const chars = original.split('');
                const pos = Math.floor(Math.random() * (chars.length - 1));
                [chars[pos], chars[pos + 1]] = [chars[pos + 1], chars[pos]];
                variants.push(chars.join(''));
            } else {
                variants.push(original.split('').reverse().join(''));
            }
            
            // S'assurer qu'on a 3 variantes uniques diff√©rentes de l'original
            const uniqueVariants = [...new Set(variants)].filter(v => v !== original);
            
            // Si pas assez de variantes, en g√©n√©rer d'autres
            while (uniqueVariants.length < 3) {
                const random = original.split('');
                const pos1 = Math.floor(Math.random() * random.length);
                const pos2 = Math.floor(Math.random() * random.length);
                [random[pos1], random[pos2]] = [random[pos2], random[pos1]];
                const variant = random.join('');
                if (variant !== original && !uniqueVariants.includes(variant)) {
                    uniqueVariants.push(variant);
                }
            }
            
            return uniqueVariants.slice(0, 3);
        }

        // ===========================================
        // WRITING
        // ===========================================
        function loadWriting(q, level) {
            const yearInput = document.getElementById('input-year');
            
            if (level === 1) {
                // Niveau 1 : Seulement l'artiste
                document.getElementById('question-text').textContent = "Qui chante ce titre ?";
                document.getElementById('input-title').style.display = 'none';
                document.getElementById('input-artist').style.display = 'block';
                yearInput.classList.add('hidden');
                
            } else if (level === 2) {
                // Niveau 2 : Titre + Artiste
                document.getElementById('question-text').textContent = "√âcris le titre et l'artiste";
                document.getElementById('input-title').style.display = 'block';
                document.getElementById('input-artist').style.display = 'block';
                yearInput.classList.add('hidden');
                
            } else {
                // Niveau 3 : Titre + Artiste + Ann√©e
                document.getElementById('question-text').textContent = "√âcris le titre, l'artiste et l'ann√©e (¬±5 ans)";
                document.getElementById('input-title').style.display = 'block';
                document.getElementById('input-artist').style.display = 'block';
                yearInput.classList.remove('hidden');
            }
            
            document.getElementById('options-container').classList.add('hidden');
            document.getElementById('writing-container').classList.remove('hidden');
            document.getElementById('input-title').value = '';
            document.getElementById('input-artist').value = '';
            document.getElementById('input-year').value = '';
            
            // Auto-check en temps r√©el
            startAutoCheck();
        }

        function startAutoCheck() {
            // Nettoyer l'ancien interval si existe
            if (gameState.autoCheckInterval) {
                clearInterval(gameState.autoCheckInterval);
            }
            
            gameState.autoCheckInterval = setInterval(() => {
                if (gameState.answered || gameState.currentTime <= 0) {
                    clearInterval(gameState.autoCheckInterval);
                    return;
                }
                
                const q = gameState.room.questions[gameState.room.currentQ];
                const titleInput = document.getElementById('input-title').value.toLowerCase().trim();
                const artistInput = document.getElementById('input-artist').value.toLowerCase().trim();
                const yearInput = parseInt(document.getElementById('input-year').value);
                
                let titleOk = false;
                let artistOk = false;
                let yearOk = false;
                
                // V√©rifier selon le niveau
                if (gameState.currentLevel === 1) {
                    // Niveau 1 : Seulement artiste
                    artistOk = checkArtist(artistInput, q.artist);
                    if (artistOk && artistInput.length > 0) {
                        submitWriting();
                    }
                    
                } else if (gameState.currentLevel === 2) {
                    // Niveau 2 : Titre + Artiste
                    titleOk = checkTitle(titleInput, q.title);
                    artistOk = checkArtist(artistInput, q.artist);
                    if (titleOk && artistOk && titleInput.length > 0 && artistInput.length > 0) {
                        submitWriting();
                    }
                    
                } else {
                    // Niveau 3 : Titre + Artiste + Ann√©e
                    titleOk = checkTitle(titleInput, q.title);
                    artistOk = checkArtist(artistInput, q.artist);
                    yearOk = checkYear(yearInput, q.year);
                    if (titleOk && artistOk && yearOk && 
                        titleInput.length > 0 && artistInput.length > 0 && !isNaN(yearInput)) {
                        submitWriting();
                    }
                }
            }, 500); // V√©rifier toutes les 500ms
        }

        function checkTitle(input, correct) {
            if (!input) return false;
            
            const titleWords = correct.toLowerCase().split(' ');
            return titleWords.some(word => 
                word.length > 2 && (
                    input.includes(word) || 
                    isSimilar(input, word) ||
                    titleWords.join(' ').includes(input)
                )
            );
        }

        function checkArtist(input, correct) {
            if (!input) return false;
            
            const artistNames = correct.toLowerCase()
                .replace(/ feat\.? /gi, ',')
                .replace(/ & /g, ',')
                .split(',')
                .map(a => a.trim());

            return artistNames.some(artist => {
                const artistWords = artist.split(' ');
                return artistWords.some(word => 
                    word.length > 2 && (
                        input.includes(word) || 
                        isSimilar(input, word) ||
                        artist.includes(input)
                    )
                );
            });
        }

        function checkYear(input, correct) {
            if (!correct || isNaN(input)) return false;
            return Math.abs(input - correct) <= 5;
        }

        function isSimilar(a, b) {
            const distance = levenshteinDistance(a, b);
            return distance <= 2;
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        // ===========================================
        // TIMER
        // ===========================================
        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);

            gameState.timerInterval = setInterval(() => {
                gameState.currentTime--;
                document.getElementById('timer').textContent = gameState.currentTime;

                if (!gameState.answered && (!gameState.distanceMode || gameState.isHost)) {
                    const blur = (gameState.currentTime / 20) * 25;
                    const coverImg = document.getElementById('cover-img');
                    if (coverImg) {
                        coverImg.style.filter = `blur(${blur}px)`;
                    }
                }

                if (gameState.currentTime <= 0) {
                    clearInterval(gameState.timerInterval);
                    if (gameState.autoCheckInterval) {
                        clearInterval(gameState.autoCheckInterval);
                    }
                    
                    const coverImg = document.getElementById('cover-img');
                    if (coverImg) {
                        coverImg.style.filter = 'blur(0px)';
                    }
                    
                    const q = gameState.room.questions[gameState.room.currentQ];
                    document.getElementById('answer-text').textContent = `${q.title} - ${q.artist}`;
                    document.getElementById('answer-reveal').classList.remove('hidden');
                    
                    if (gameState.distanceMode || gameState.isHost) {
                        const audio = document.getElementById('audio-player');
                        if (audio) audio.pause();
                    }

                    if (gameState.isHost && !gameState.answered) {
                        gameState.answered = true;
                    }
                    
                    setTimeout(() => {
                        if (gameState.isHost) {
                            db.ref(`rooms/${gameState.room.code}/currentQ`).once('value', snapshot => {
                                const currentQ = snapshot.val();
                                db.ref(`rooms/${gameState.room.code}/currentQ`).set(currentQ + 1);
                            });
                        }
                    }, 2500);
                }
            }, 1000);
        }

        // ===========================================
        // SUBMIT
        // ===========================================
        function submitQCM(answer, correct) {
            if (gameState.answered) return;
            gameState.answered = true;

            const isCorrect = answer === correct;
            const pts = isCorrect ? (50 + gameState.currentTime * 10) : 0;
            
            document.querySelectorAll('.opt').forEach(btn => {
                btn.classList.add('disabled');
                btn.onclick = null;
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else {
                    btn.classList.add('wrong');
                }
            });

            showResult(isCorrect, pts, `${gameState.room.questions[gameState.room.currentQ].title} - ${gameState.room.questions[gameState.room.currentQ].artist}`);
            updateScore(pts);
        }

        function submitWriting() {
            if (gameState.answered) return;
            gameState.answered = true;
            
            // Arr√™ter l'auto-check
            if (gameState.autoCheckInterval) {
                clearInterval(gameState.autoCheckInterval);
            }

            const q = gameState.room.questions[gameState.room.currentQ];
            const titleInput = document.getElementById('input-title').value.toLowerCase().trim();
            const artistInput = document.getElementById('input-artist').value.toLowerCase().trim();
            const yearInput = parseInt(document.getElementById('input-year').value);

            let titleOk = false;
            let artistOk = false;
            let yearOk = false;
            
            // V√©rifier selon le niveau
            if (gameState.currentLevel === 1) {
                // Niveau 1 : Seulement artiste
                artistOk = checkArtist(artistInput, q.artist);
                
                // Validation : ne pas accepter de r√©ponse vide
                if (!artistInput || artistInput.length === 0) {
                    artistOk = false;
                }
                
            } else if (gameState.currentLevel === 2) {
                // Niveau 2 : Titre + Artiste
                titleOk = checkTitle(titleInput, q.title);
                artistOk = checkArtist(artistInput, q.artist);
                
                // Validation : ne pas accepter de r√©ponses vides
                if (!titleInput || titleInput.length === 0) titleOk = false;
                if (!artistInput || artistInput.length === 0) artistOk = false;
                
            } else {
                // Niveau 3 : Titre + Artiste + Ann√©e
                titleOk = checkTitle(titleInput, q.title);
                artistOk = checkArtist(artistInput, q.artist);
                yearOk = checkYear(yearInput, q.year);
                
                // Validation : ne pas accepter de r√©ponses vides
                if (!titleInput || titleInput.length === 0) titleOk = false;
                if (!artistInput || artistInput.length === 0) artistOk = false;
                if (isNaN(yearInput)) yearOk = false;
            }

            let isCorrect = false;
            let pts = 0;
            let feedback = '';

            if (gameState.currentLevel === 1) {
                // Niveau 1 : Juste artiste
                if (artistOk) {
                    isCorrect = true;
                    pts = 50 + gameState.currentTime * 10;
                    feedback = 'Parfait !';
                }
                
            } else if (gameState.currentLevel === 2) {
                // Niveau 2 : Titre + Artiste
                if (titleOk && artistOk) {
                    isCorrect = true;
                    pts = 50 + gameState.currentTime * 10;
                    feedback = 'Parfait !';
                } else if (titleOk) {
                    pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                    feedback = 'Bon titre ! (50%)';
                } else if (artistOk) {
                    pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                    feedback = 'Bon artiste ! (50%)';
                }
                
            } else {
                // Niveau 3 : Titre + Artiste + Ann√©e
                const baseScore = 50 + gameState.currentTime * 10;
                
                if (titleOk && artistOk && yearOk) {
                    isCorrect = true;
                    pts = baseScore;
                    feedback = 'Parfait !';
                } else if (titleOk && artistOk) {
                    pts = Math.floor(baseScore * 0.66);
                    feedback = 'Titre & Artiste ! (66%)';
                } else if (titleOk && yearOk) {
                    pts = Math.floor(baseScore * 0.5);
                    feedback = 'Titre & Ann√©e ! (50%)';
                } else if (artistOk && yearOk) {
                    pts = Math.floor(baseScore * 0.5);
                    feedback = 'Artiste & Ann√©e ! (50%)';
                } else if (titleOk) {
                    pts = Math.floor(baseScore * 0.33);
                    feedback = 'Bon titre ! (33%)';
                } else if (artistOk) {
                    pts = Math.floor(baseScore * 0.33);
                    feedback = 'Bon artiste ! (33%)';
                } else if (yearOk) {
                    pts = Math.floor(baseScore * 0.33);
                    feedback = 'Bonne ann√©e ! (33%)';
                }
            }

            const answerText = gameState.currentLevel === 3 && q.year ? 
                `${q.title} - ${q.artist} (${q.year})` : 
                `${q.title} - ${q.artist}`;
            
            showResult(isCorrect || pts > 0, pts, answerText, feedback);
            updateScore(pts);
        }

        function showResult(isCorrect, pts, answer, feedback = '') {
            const container = document.getElementById('result-container');
            container.classList.remove('hidden', 'correct', 'wrong');
            container.classList.add(isCorrect ? 'correct' : 'wrong');
            
            if (pts > 0) {
                container.textContent = `üéâ ${feedback} +${pts} pts`;
            } else {
                container.textContent = `‚ùå ${answer}`;
            }
        }

        function updateScore(pts) {
            const players = [...gameState.room.players];
            players[gameState.playerIndex].score = (players[gameState.playerIndex].score || 0) + pts;
            
            db.ref(`rooms/${gameState.room.code}/players`).set(players);
        }

        function toggleAudio() {
            const audio = document.getElementById('audio-player');
            const btn = event.target;
            
            if (audio.paused) {
                audio.play();
                btn.textContent = 'üéµ Stop';
            } else {
                audio.pause();
                btn.textContent = 'üéµ Play';
            }
        }

        // ===========================================
        // LEADERBOARD
        // ===========================================
        function goToLeaderboard() {
            console.log('üèÜ LEADERBOARD');
            
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            if (gameState.autoCheckInterval) clearInterval(gameState.autoCheckInterval);
            if (gameState.roomRef) gameState.roomRef.off();

            showScreen('leaderboard-screen');

            const players = gameState.room.players || [];
            const sorted = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));

            // Sauvegarder dans le leaderboard permanent
            saveToAllTimeLeaderboard(sorted[0]);

            const podium = document.getElementById('podium-container');
            podium.innerHTML = '';
            
            sorted.slice(0, 3).forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'podium-item';
                div.innerHTML = `
                    <div class="medal">${['ü•á','ü•à','ü•â'][i]}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-score">${p.score || 0} pts</div>
                `;
                podium.appendChild(div);
            });

            const list = document.getElementById('leaderboard-container');
            list.innerHTML = '';
            
            sorted.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'lb-row';
                div.innerHTML = `
                    <span class="rank">#${i + 1}</span>
                    <span class="name">${p.name}</span>
                    <span class="pts">${p.score || 0} pts</span>
                `;
                list.appendChild(div);
            });
            
            // Afficher aussi le leaderboard permanent
            displayAllTimeLeaderboard();
        }

        // ===========================================
        // ALL-TIME LEADERBOARD
        // ===========================================
        async function saveToAllTimeLeaderboard(winner) {
            if (!winner || !winner.score) return;
            
            try {
                const snapshot = await db.ref('allTimeLeaderboard').once('value');
                let leaderboard = snapshot.val() || [];
                
                // Ajouter le nouveau score
                leaderboard.push({
                    name: winner.name,
                    score: winner.score,
                    date: new Date().toISOString()
                });
                
                // Trier par score d√©croissant
                leaderboard.sort((a, b) => b.score - a.score);
                
                // Garder seulement les 10 meilleurs
                leaderboard = leaderboard.slice(0, 10);
                
                // Sauvegarder
                await db.ref('allTimeLeaderboard').set(leaderboard);
                
                console.log('‚úÖ Score sauvegard√© dans le leaderboard permanent');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde leaderboard:', error);
            }
        }

        async function displayAllTimeLeaderboard() {
            try {
                const snapshot = await db.ref('allTimeLeaderboard').once('value');
                const leaderboard = snapshot.val() || [];
                
                const container = document.getElementById('alltime-container');
                container.innerHTML = '';
                
                if (leaderboard.length === 0) {
                    container.innerHTML = '<p style="color: #aaa; text-align: center;">Aucun score enregistr√©</p>';
                    return;
                }
                
                leaderboard.forEach((entry, i) => {
                    const div = document.createElement('div');
                    div.className = 'alltime-row';
                    const date = new Date(entry.date).toLocaleDateString('fr-FR');
                    div.innerHTML = `
                        <span class="rank">#${i + 1}</span>
                        <span class="name">${entry.name}</span>
                        <span class="pts">${entry.score} pts</span>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('‚ùå Erreur chargement leaderboard:', error);
            }
        }

        function switchLeaderboardTab(tab) {
            // Changer l'onglet actif
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'game') {
                document.getElementById('game-leaderboard').classList.remove('hidden');
                document.getElementById('alltime-leaderboard').classList.add('hidden');
            } else {
                document.getElementById('game-leaderboard').classList.add('hidden');
                document.getElementById('alltime-leaderboard').classList.remove('hidden');
                displayAllTimeLeaderboard();
            }
        }

        function restartGame() {
            goToMenu();
        }

        // ===========================================
        // INIT
        // ===========================================
        console.log('‚úÖ Quiz Party V2 FIXED charg√© !');
    </script>
</body>
</html>
