<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTG - Blind Test üéµ</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #0a0e27;
            color: white;
            min-height: 100vh;
        }

        .app { min-height: 100vh; position: relative; }

        .bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 0, 110, 0.1), transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(131, 56, 236, 0.1), transparent 50%);
            animation: pulse 8s infinite;
            z-index: 0;
        }

        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

        .screen {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hidden { display: none !important; }

        /* MENU */
        .logo { text-align: center; margin-bottom: 2rem; }
        .title {
            font-family: 'Bungee Shade', cursive;
            font-size: 4rem;
            background: linear-gradient(45deg, #ff006e, #00f5ff, #ffbe0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            font-size: 1.2rem;
            color: #00f5ff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 400px;
        }

        /* BUTTONS */
        .btn {
            background: linear-gradient(135deg, #ff006e, #8338ec);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            margin: 0.3rem;
        }

        .btn:hover:not(:disabled) { transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.large { padding: 1.5rem 3rem; font-size: 1.3rem; }
        .btn.secondary { background: linear-gradient(135deg, #00f5ff, #ffbe0b); }
        .btn.danger { background: linear-gradient(135deg, #ff006e, #ff4444); }

        /* INPUTS */
        .input, .select {
            width: 100%;
            max-width: 400px;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #8338ec;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .input:focus, .select:focus { outline: none; border-color: #ff006e; }
        .code-input { font-size: 2rem; text-align: center; letter-spacing: 0.5em; }

        /* SECTIONS */
        .section { margin: 1.5rem 0; text-align: center; width: 100%; max-width: 500px; }
        .section h3 { color: #00f5ff; margin-bottom: 1rem; }

        .num-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            max-width: 400px;
            margin: 0 auto;
        }

        .num-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            color: white;
            padding: 0.8rem;
            font-size: 1.1rem;
            font-weight: 800;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }

        .num-btn:hover { background: rgba(255, 255, 255, 0.1); }
        .num-btn.active { background: linear-gradient(135deg, #ff006e, #8338ec); border-color: #ff006e; }

        /* CHECKBOX */
        .checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            margin: 0.5rem 0;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: all 0.3s;
        }

        .checkbox-label:hover { background: rgba(0, 0, 0, 0.4); }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label span {
            color: #00f5ff;
            font-weight: 600;
        }

        /* PLAYLISTS */
        .playlists-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 1rem 0;
        }

        .playlist-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .playlist-name {
            flex: 1;
            font-weight: 600;
            color: #ffbe0b;
        }

        .playlist-url {
            flex: 2;
            font-size: 0.8rem;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* LOBBY */
        .code-display {
            text-align: center;
            background: linear-gradient(135deg, #1a1f3a, #2a2f4a);
            border: 3px solid #ffbe0b;
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(255, 190, 11, 0.3);
        }

        .code-label { color: #aaa; font-size: 1rem; margin-bottom: 1rem; }
        .code-value {
            font-size: 5rem;
            font-weight: 800;
            color: #ffbe0b;
            letter-spacing: 0.3em;
            text-shadow: 0 0 30px rgba(255, 190, 11, 0.6);
        }

        .players-box {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .players-box h3 { color: #00f5ff; margin-bottom: 1rem; }

        .player {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .player-num {
            background: #8338ec;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .player-name { flex: 1; font-weight: 600; }

        .waiting { text-align: center; margin-top: 2rem; }
        .waiting p { font-size: 1.2rem; color: #ffbe0b; margin-top: 1rem; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ff006e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* GAME */
        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-bottom: 1.5rem;
            background: #1a1f3a;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            border: 2px solid #8338ec;
            font-weight: 800;
        }

        .timer { color: #ff006e; font-size: 1.3rem; }
        .score { color: #ffbe0b; font-size: 1.3rem; }

        .game-container {
            display: flex;
            gap: 2rem;
            width: 100%;
            max-width: 1200px;
            align-items: flex-start;
        }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .scoreboard-side {
            width: 250px;
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            position: sticky;
            top: 20px;
        }

        .scoreboard-side h3 {
            color: #00f5ff;
            margin-bottom: 1rem;
            text-align: center;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .score-item.me {
            background: rgba(255, 190, 11, 0.2);
            border: 1px solid #ffbe0b;
        }

        .score-name { font-weight: 600; }
        .score-points { color: #ffbe0b; font-weight: 800; }

        .img-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 1.5rem;
            border-radius: 20px;
            overflow: hidden;
        }

        .cover {
            width: 100%;
            height: 400px;
            object-fit: cover;
            transition: filter 0.3s ease;
        }

        .answer-reveal {
            text-align: center;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid #00f5ff;
        }

        .answer-reveal h4 {
            color: #00f5ff;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .answer-reveal .answer-text {
            color: #ffbe0b;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .audio-box { text-align: center; margin: 1rem 0; }

        .audio-btn {
            background: linear-gradient(135deg, #ffbe0b, #ff006e);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .question-box { width: 100%; max-width: 600px; margin: 0 auto; }

        .q-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: #00f5ff;
            margin-bottom: 1.5rem;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .opt {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #8338ec;
            padding: 1.5rem;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .opt:hover { background: rgba(131, 56, 236, 0.2); transform: scale(1.05); }
        .opt.correct { background: rgba(0, 255, 100, 0.2); border-color: #00ff64; }
        .opt.wrong { background: rgba(255, 0, 0, 0.2); border-color: #ff0033; }
        .opt.disabled { cursor: not-allowed; opacity: 0.6; }

        .result {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .result.correct { background: rgba(0, 255, 100, 0.2); border: 2px solid #00ff64; color: #00ff64; }
        .result.wrong { background: rgba(255, 0, 0, 0.2); border: 2px solid #ff0033; color: #ff6b6b; }

        /* LEADERBOARD */
        .leaderboard-title {
            font-size: 3rem;
            font-weight: 800;
            color: #ffbe0b;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(255, 190, 11, 0.5);
        }

        .podium {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .podium-item {
            background: #1a1f3a;
            border: 3px solid #8338ec;
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            min-width: 150px;
        }

        .medal { font-size: 3rem; margin-bottom: 0.5rem; }
        .p-name { font-weight: 800; font-size: 1.2rem; color: #ffbe0b; margin: 0.5rem 0; }
        .p-score { font-size: 1.5rem; font-weight: 800; color: #ff006e; }

        .leaderboard {
            background: #1a1f3a;
            border: 2px solid #8338ec;
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin: 2rem 0;
        }

        .lb-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .rank {
            background: #8338ec;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .name { flex: 1; font-weight: 600; }
        .pts { font-weight: 800; color: #ffbe0b; font-size: 1.2rem; }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-text {
            color: #ffbe0b;
            font-size: 1.5rem;
            font-weight: 800;
            margin-top: 2rem;
        }

        /* BOUTON SECOURS */
        .emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            z-index: 9999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif;
        }

        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .options { grid-template-columns: 1fr; }
            .cover { height: 300px; }
            .code-value { font-size: 3rem; }
            .game-container { flex-direction: column; }
            .scoreboard-side { width: 100%; position: relative; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="bg"></div>

        <!-- LOADING -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">Chargement...</div>
        </div>

        <!-- MENU -->
        <div id="menu-screen" class="screen">
            <div class="logo">
                <h1 class="title">Blind Test <img src="ptgmusique.png" alt="logo" style="height: 70px; width: 120px;"></h1>
                <p class="subtitle" style="display: inline-flex; align-items: center; justify-content: center; gap: 12px;">By Play Thau'Gether</p>
            </div>
            <div class="menu-buttons">
                <button class="btn large" onclick="goToCreate()">üéÆ Cr√©er une partie</button>
                <button class="btn large secondary" onclick="goToJoin()">üë• Rejoindre une partie</button>
                <button class="btn" onclick="goToPlaylists()">üìã G√©rer Playlists</button>
            </div>
        </div>

        <!-- PLAYLISTS -->
        <div id="playlists-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üìã Mes Playlists</h2>
            
            <div class="playlists-box">
                <h3 style="color: #00f5ff; margin-bottom: 1rem;">Playlists enregistr√©es</h3>
                <div id="playlists-list"></div>
                <button class="btn" onclick="showAddPlaylist()" style="margin-top: 1rem;">‚ûï Ajouter une playlist</button>
            </div>

            <div id="add-playlist-form" class="section hidden">
                <h3>Nouvelle Playlist</h3>
                <input id="new-playlist-name" class="input" placeholder="Nom de la playlist">
                <input id="new-playlist-url" class="input" placeholder="URL Deezer">
                <button class="btn" onclick="savePlaylist()">üíæ Enregistrer</button>
            </div>

            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- CREATE -->
        <div id="create-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üéÆ Cr√©er une partie</h2>
            
            <input id="create-name" class="input" placeholder="Ton pseudo" maxlength="20">
            
            <div class="section">
                <h3>üéØ Mode de jeu</h3>
                <select id="create-mode" class="select">
                    <option value="qcm">QCM (Choix multiples)</option>
                    <option value="writing">√âcriture (Titre + Artiste)</option>
                    <option value="title-only">Titres uniquement</option>
                    <option value="soiree">Soir√©e (Mix QCM + √âcriture)</option>
                </select>
            </div>

            <div class="section">
                <h3>‚öôÔ∏è Options</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="host-mode">
                    <span>Mode H√¥te (Affichage seulement)</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="distance-mode">
                    <span>Mode Distance (Son sur tous les appareils)</span>
                </label>
            </div>

            <div class="section">
                <h3>üî¢ Nombre de questions</h3>
                <div class="num-grid">
                    <button class="num-btn" onclick="selectNumQ(5)">5</button>
                    <button class="num-btn active" onclick="selectNumQ(10)">10</button>
                    <button class="num-btn" onclick="selectNumQ(15)">15</button>
                    <button class="num-btn" onclick="selectNumQ(20)">20</button>
                    <button class="num-btn" onclick="selectNumQ(30)">30</button>
                </div>
            </div>

            <div class="section">
                <h3>üéµ Choisir une playlist</h3>
                
                <!-- TABS -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <button class="btn large" onclick="switchPlaylistTab('deezer')" id="tab-deezer" style="flex: 1; background: #ffbe0b;">
                        üéµ Deezer
                    </button>
                    <button class="btn large" onclick="switchPlaylistTab('custom')" id="tab-custom" style="flex: 1; background: rgba(255,255,255,0.1);">
                        üé® Playlist Perso
                    </button>
                </div>
                
                <!-- DEEZER TAB -->
                <div id="deezer-tab" style="display: block;">
                    <select id="playlist-select" class="select">
                        <option value="">-- S√©lectionner --</option>
                    </select>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #aaa;">
                        Ou ajouter une URL personnalis√©e :
                    </p>
                    <input id="custom-playlist-url" class="input" placeholder="URL Playlist Deezer">
                </div>
                
                <!-- CUSTOM TAB -->
                <div id="custom-tab" style="display: none;">
                    <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #aaa;">
                        üìù Colle le contenu de ton fichier JSON ici :
                    </p>
                    <textarea id="custom-json" class="input" placeholder='{"playlist": [{"title": "...", "artist": "...", "preview": "...", "cover": "..."}]}' style="min-height: 200px; font-family: monospace; font-size: 0.85rem; resize: vertical;"></textarea>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #00f5ff;">
                        üí° Utilise le <a href="playlist-generator.html" target="_blank" style="color: #ffbe0b; font-weight: 600;">g√©n√©rateur JSON</a> pour cr√©er ta playlist facilement !
                    </p>
                </div>
                
                <button class="btn large" onclick="loadAndCreate()">üöÄ Cr√©er la partie</button>
            </div>

            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- JOIN -->
        <div id="join-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">üë• Rejoindre</h2>
            <input id="join-name" class="input" placeholder="Ton pseudo" maxlength="20">
            <input id="join-code" class="input code-input" placeholder="123456" type="tel" maxlength="6">
            <button class="btn large" onclick="joinRoom()">‚ñ∂Ô∏è Rejoindre</button>
            <button class="btn" onclick="goToMenu()" style="margin-top: 2rem;">üè† Retour</button>
        </div>

        <!-- LOBBY -->
        <div id="lobby-screen" class="screen hidden">
            <h2 style="font-size: 2.5rem; color: #ffbe0b; margin-bottom: 2rem;">Salle d'attente</h2>
            
            <div class="code-display">
                <div class="code-label">Code de la partie</div>
                <div class="code-value" id="lobby-code">000000</div>
            </div>

            <div class="players-box">
                <h3>üë• Joueurs (<span id="player-count">0</span>)</h3>
                <div id="players-list"></div>
            </div>

            <button id="start-btn" class="btn large hidden" onclick="startGame()">‚ñ∂Ô∏è Lancer la partie</button>
            <div id="waiting-div" class="waiting hidden">
                <div class="spinner"></div>
                <p>En attente de l'h√¥te...</p>
            </div>
        </div>

        <!-- LEVEL TRANSITION -->
        <div id="level-transition-screen" class="screen hidden">
            <div style="text-align: center;">
                <h1 style="font-size: 4rem; color: #ffbe0b; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(255,190,11,0.5);">
                    üéØ NIVEAU <span id="next-level-num">2</span>
                </h1>
                <p style="font-size: 1.5rem; color: #00f5ff;" id="level-desc">Questions normales</p>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- MODE START COUNTDOWN (10s) -->
        <div id="mode-start-screen" class="screen hidden">
            <div style="text-align: center;">
                <h1 style="font-size: 4rem; color: #00f5ff; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(0,245,255,0.5);" id="mode-start-title">
                    üéÆ MODE QCM
                </h1>
                <div style="font-size: 8rem; color: #ffbe0b; font-weight: 800; text-shadow: 0 0 50px rgba(255,190,11,0.8);" id="countdown-number">
                    10
                </div>
                <p style="font-size: 1.5rem; color: white; margin-top: 2rem;">Pr√©parez-vous...</p>
            </div>
        </div>

        <!-- QCM LEVEL 1 INTRO -->
        <div id="qcm-lvl1-intro-screen" class="screen hidden">
            <div style="text-align: center; max-width: 700px; margin: 0 auto;">
                <h1 style="font-size: 3.5rem; color: #00f5ff; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(0,245,255,0.5);">
                    üéØ MODE QCM
                </h1>
                <div style="background: rgba(0, 245, 255, 0.1); border: 3px solid #00f5ff; border-radius: 20px; padding: 2rem;">
                    <h2 style="color: #ffbe0b; font-size: 2.5rem; margin-bottom: 1rem;">NIVEAU 1</h2>
                    <p style="font-size: 1.5rem; color: white; font-weight: 800;">2 CHOIX DE R√âPONSE</p>
                </div>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- QCM LEVEL 2 INTRO -->
        <div id="qcm-lvl2-intro-screen" class="screen hidden">
            <div style="text-align: center; max-width: 700px; margin: 0 auto;">
                <h1 style="font-size: 3.5rem; color: #00f5ff; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(0,245,255,0.5);">
                    üéØ MODE QCM
                </h1>
                <div style="background: rgba(0, 245, 255, 0.1); border: 3px solid #00f5ff; border-radius: 20px; padding: 2rem;">
                    <h2 style="color: #ffbe0b; font-size: 2.5rem; margin-bottom: 1rem;">NIVEAU 2</h2>
                    <p style="font-size: 1.5rem; color: white; font-weight: 800;">4 CHOIX DE R√âPONSE</p>
                </div>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- WRITING LEVEL 1 INTRO -->
        <div id="writing-lvl1-intro-screen" class="screen hidden">
            <div style="text-align: center; max-width: 700px; margin: 0 auto;">
                <h1 style="font-size: 3.5rem; color: #ff006e; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(255,0,110,0.5);">
                    ‚úçÔ∏è MODE √âCRITURE
                </h1>
                <div style="background: rgba(255, 0, 110, 0.1); border: 3px solid #ff006e; border-radius: 20px; padding: 2rem;">
                    <h2 style="color: #ffbe0b; font-size: 2.5rem; margin-bottom: 1.5rem;">NIVEAU 1</h2>
                    <p style="font-size: 1.5rem; color: white; font-weight: 800; margin-bottom: 1.5rem;">
                        TAPER LE NOM DE L'ARTISTE
                    </p>
                    <div style="background: rgba(255, 190, 11, 0.2); padding: 1rem; border-radius: 10px; margin-top: 1.5rem;">
                        <p style="font-size: 1.2rem; color: #ffbe0b; font-weight: 800;">‚ö†Ô∏è ATTENTION</p>
                        <p style="font-size: 1rem; color: white; margin-top: 0.5rem;">Orthographe parfaite !</p>
                        <p style="font-size: 1rem; color: white;">PENSEZ √Ä VALIDER</p>
                    </div>
                </div>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- WRITING LEVEL 2 INTRO -->
        <div id="writing-lvl2-intro-screen" class="screen hidden">
            <div style="text-align: center; max-width: 700px; margin: 0 auto;">
                <h1 style="font-size: 3.5rem; color: #ff006e; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(255,0,110,0.5);">
                    ‚úçÔ∏è MODE √âCRITURE
                </h1>
                <div style="background: rgba(255, 0, 110, 0.1); border: 3px solid #ff006e; border-radius: 20px; padding: 2rem;">
                    <h2 style="color: #ffbe0b; font-size: 2.5rem; margin-bottom: 1.5rem;">NIVEAU 2</h2>
                    <p style="font-size: 1.5rem; color: white; font-weight: 800; margin-bottom: 1.5rem;">
                        TAPER LE TITRE ET LE NOM DE L'ARTISTE
                    </p>
                    <div style="background: rgba(255, 190, 11, 0.2); padding: 1rem; border-radius: 10px; margin-top: 1.5rem;">
                        <p style="font-size: 1.2rem; color: #ffbe0b; font-weight: 800;">‚ö†Ô∏è ATTENTION</p>
                        <p style="font-size: 1rem; color: white; margin-top: 0.5rem;">Orthographe parfaite !</p>
                        <p style="font-size: 1rem; color: white;">PENSEZ √Ä VALIDER</p>
                    </div>
                </div>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- WRITING TRANSITION (ancien, on garde pour compatibilit√©) -->
        <div id="writing-transition-screen" class="screen hidden">
            <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                <h1 style="font-size: 3.5rem; color: #ff006e; margin-bottom: 2rem; text-shadow: 0 0 30px rgba(255,0,110,0.5);">
                    ‚úçÔ∏è MODE √âCRITURE
                </h1>
                <div style="background: rgba(255, 0, 110, 0.1); border: 3px solid #ff006e; border-radius: 20px; padding: 2rem; margin: 2rem 0;">
                    <h2 style="color: #ffbe0b; font-size: 2rem; margin-bottom: 1.5rem;">‚ö†Ô∏è ATTENTION</h2>
                    <p style="font-size: 1.3rem; color: white; margin-bottom: 1rem;">
                        üìù <strong>Orthographe PARFAITE requise !</strong>
                    </p>
                    <p style="font-size: 1.3rem; color: white; margin-bottom: 1rem;">
                        ‚úÖ <strong>N'oubliez pas de VALIDER votre r√©ponse !</strong>
                    </p>
                    <p style="font-size: 1rem; color: #aaa; margin-top: 1.5rem;">
                        (Les majuscules ne comptent pas)
                    </p>
                </div>
                <div class="spinner" style="margin: 3rem auto;"></div>
            </div>
        </div>

        <!-- GAME -->
        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                <div class="timer">‚è±Ô∏è <span id="timer">20</span>s</div>
                <div>Q <span id="current-q">1</span>/<span id="total-q">10</span></div>
                <div class="score">üèÜ <span id="player-score">0</span></div>
            </div>

            <div class="game-container">
                <!-- SCOREBOARD TEMPS R√âEL -->
                <div id="scoreboard-side" class="scoreboard-side">
                    <h3>üèÜ Scores</h3>
                    <div id="live-scores"></div>
                </div>

                <!-- GAME PRINCIPAL -->
                <div class="game-main">
                    <div class="img-box">
                        <img id="cover-img" class="cover" src="" alt="Cover">
                        <div id="answer-reveal" class="answer-reveal hidden">
                            <h4>R√©ponse :</h4>
                            <div class="answer-text" id="answer-text"></div>
                        </div>
                    </div>

                    <div id="audio-box" class="audio-box hidden">
                        <audio id="audio-player" loop></audio>
                        <button class="audio-btn" onclick="toggleAudio()">üéµ Play</button>
                    </div>

                    <div class="question-box">
                        <h3 id="question-text" class="q-text"></h3>
                        <div id="options-container" class="options hidden"></div>
                        <div id="writing-container" class="hidden">
                            <input id="input-title" class="input" placeholder="Titre">
                            <input id="input-artist" class="input" placeholder="Artiste">
                            <button class="btn" onclick="submitWriting()">Valider</button>
                        </div>
                        <div id="result-container" class="result hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD -->
        <div id="leaderboard-screen" class="screen hidden">
            <h1 class="leaderboard-title">üèÜ CLASSEMENT FINAL üèÜ</h1>
            <div id="podium-container" class="podium"></div>
            <div id="leaderboard-container" class="leaderboard"></div>
            <button class="btn large" onclick="restartGame()">üè† Nouvelle partie</button>
        </div>

        <!-- BOUTON SECOURS -->
        <button id="emergency-btn" class="emergency-btn hidden" onclick="emergencyReset()">üè† MENU</button>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ===========================================
        // CONFIG (√Ä d√©placer dans variables d'environnement pour production)
        // ===========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAWA-Zfs_hljCFz1wc0Rg2LJWZPINWONnU",
            authDomain: "quizz-party-ptg.firebaseapp.com",
            databaseURL: "https://quizz-party-ptg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "quizz-party-ptg",
            storageBucket: "quizz-party-ptg.firebasestorage.app",
            messagingSenderId: "352511986737",
            appId: "1:352511986737:web:7318d807b4d3f3b6b29910"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        // ===========================================
        // √âTAT GLOBAL
        // ===========================================
        let currentScreen = 'menu';
        let gameState = {
            room: null,
            playerIndex: 0,
            isHost: false,
            numQuestions: 10,
            musicDB: [],
            currentTime: 20,
            timerInterval: null,
            answered: false,
            roomRef: null,
            audioPlaying: false,
            hostDisplayOnly: false,
            distanceMode: false
        };

        // ===========================================
        // SESSION (reconnexion apr√®s rafra√Æchissement)
        // ===========================================
        function saveSession() {
            const session = {
                code: gameState.room.code,
                name: gameState.room.players[gameState.playerIndex].name,
                isHost: gameState.isHost
            };
            localStorage.setItem('quizPartySession', JSON.stringify(session));
        }

        function clearSession() {
            localStorage.removeItem('quizPartySession');
        }

        function tryReconnect() {
            const raw = localStorage.getItem('quizPartySession');
            if (!raw) return;

            let session;
            try { session = JSON.parse(raw); } catch(e) { clearSession(); return; }
            if (!session || !session.code || !session.name) { clearSession(); return; }

            console.log('üîÑ Session trouv√©e, tentative de reconnexion...', session);

            db.ref(`rooms/${session.code}`).once('value', snapshot => {
                const room = snapshot.val();

                // Room plus en vie sur Firebase
                if (!room) {
                    console.log('‚ùå Room introuvable, session effac√©e.');
                    clearSession();
                    return;
                }

                // Trouver le joueur par son nom
                const idx = room.players.findIndex(p => p.name === session.name);
                if (idx === -1) {
                    console.log('‚ùå Joueur introuvable dans la room.');
                    clearSession();
                    return;
                }

                // Partie termin√©e
                if (room.currentQ >= room.questions.length) {
                    console.log('‚úÖ Partie d√©j√† termin√©e.');
                    clearSession();
                    return;
                }

                // Tout bon ‚Äî on reconnecte
                console.log('‚úÖ Reconnexion r√©ussie !');
                gameState.room = room;
                gameState.playerIndex = idx;
                gameState.distanceMode = room.distanceMode || false;

                // V√©rifier depuis Firebase si c'est vraiment l'h√¥te (pas la session)
                gameState.isHost = (room.host === session.name);
                // hostDisplayOnly UNIQUEMENT si c'est l'h√¥te ET que le mode h√¥te est activ√©
                gameState.hostDisplayOnly = gameState.isHost && (room.hostMode || false);
                // Reconstruire musicDB depuis les questions (n√©cessaire pour g√©n√©rer les fausses r√©ponses QCM)
                gameState.musicDB = room.questions.map(q => ({
                    title: q.title,
                    artist: q.artist,
                    cover: q.cover,
                    preview: q.preview
                }));

                if (room.started) {
                    // Partie en cours ‚Üí on BLOQUE sur la question suivante
                    gameState.waitingForNextQ = true;
                    gameState.lastSeenQ = room.currentQ; // On m√©morise la question actuelle
                    showScreen('game-screen');
                    document.getElementById('options-container').classList.add('hidden');
                    document.getElementById('writing-container').classList.add('hidden');
                    document.getElementById('question-text').textContent = '‚è≥ Attends la question suivante...';
                    document.getElementById('answer-reveal').classList.add('hidden');
                    document.getElementById('result-container').classList.add('hidden');
                    document.getElementById('timer').textContent = '‚Äî';
                    const coverBox = document.querySelector('.img-box');
                    if (coverBox) coverBox.style.display = 'none';
                    gameState.answered = true;
                    listenToRoom();
                } else {
                    // Pas encore lanc√©e ‚Üí on retourne au lobby
                    goToLobby();
                }
            });
        }
        // TON SERVEUR BACKEND !
        const BACKEND_URL = 'https://blind-test-ptg.vercel.app';

        async function fetchWithProxy(url) {
            // Plus besoin de proxies ! On utilise TON serveur !
            try {
                console.log('üîÑ Chargement via ton serveur...');
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Donn√©es charg√©es !');
                return data;
                
            } catch (error) {
                console.error('‚ùå Erreur:', error.message);
                throw new Error(`Erreur de chargement: ${error.message}`);
            }
        }

        async function getDeezerPlaylist(id) {
            try {
                console.log('üéµ Chargement playlist via TON serveur:', id);
                
                // Utiliser TON backend au lieu de l'API Deezer directement
                const data = await fetchWithProxy(`${BACKEND_URL}/api/deezer/playlist/${id}`);
                
                // V√©rifier que c'est un objet valide
                if (!data || !data.tracks || !data.tracks.data) {
                    throw new Error('Format de r√©ponse invalide');
                }
                
                const tracks = data.tracks.data
                    .filter(t => t && t.preview && t.album && t.album.cover_big && t.title && t.artist)
                    .map(t => ({
                        title: t.title,
                        artist: t.artist.name,
                        cover: t.album.cover_big,
                        preview: t.preview,
                        year: t.album.release_date ? new Date(t.album.release_date).getFullYear() : null
                    }));
                
                console.log(`‚úÖ ${tracks.length} morceaux charg√©s`);
                return tracks;
                
            } catch (error) {
                console.error('‚ùå Erreur Deezer:', error);
                throw new Error(`Impossible de charger la playlist.\n\nD√©tails: ${error.message}`);
            }
        }

        // Tester si une preview fonctionne
        async function testPreview(url) {
            return new Promise((resolve) => {
                const audio = new Audio(url);
                audio.addEventListener('canplaythrough', () => resolve(true), { once: true });
                audio.addEventListener('error', () => resolve(false), { once: true });
                audio.load();
                setTimeout(() => resolve(false), 3000); // Timeout 3s
            });
        }

        // Filtrer les musiques cass√©es
        async function filterWorkingTracks(tracks) {
            showLoading('Test des musiques...');
            const results = [];
            
            for (let i = 0; i < tracks.length; i++) {
                updateLoading(`Test ${i + 1}/${tracks.length}...`);
                const works = await testPreview(tracks[i].preview);
                if (works) {
                    results.push(tracks[i]);
                }
            }
            
            hideLoading();
            return results;
        }

        // ===========================================
        // UTILS
        // ===========================================
        function shuffle(arr) {
            return [...arr].sort(() => Math.random() - 0.5);
        }

        function genCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId.replace('-screen', '');
            
            const emergency = document.getElementById('emergency-btn');
            if (screenId === 'menu-screen' || screenId === 'leaderboard-screen') {
                emergency.classList.add('hidden');
            } else {
                emergency.classList.remove('hidden');
            }
        }

        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function updateLoading(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Fonction pour v√©rifier similarit√© (tol√©rance 1 lettre)
        function isSimilar(a, b) {
            a = a.toLowerCase().trim();
            b = b.toLowerCase().trim();
            
            if (a === b) return true;
            if (Math.abs(a.length - b.length) > 1) return false;
            
            let diff = 0;
            const maxLen = Math.max(a.length, b.length);
            
            for (let i = 0; i < maxLen; i++) {
                if (a[i] !== b[i]) diff++;
                if (diff > 1) return false;
            }
            
            return diff <= 1;
        }

        // ===========================================
        // NAVIGATION
        // ===========================================
        function goToMenu() {
            if (gameState.roomRef) gameState.roomRef.off();
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            clearSession();
            gameState = {
                room: null,
                playerIndex: 0,
                isHost: false,
                numQuestions: 10,
                musicDB: [],
                currentTime: 20,
                timerInterval: null,
                answered: false,
                roomRef: null,
                audioPlaying: false,
                hostDisplayOnly: false,
                distanceMode: false
            };
            showScreen('menu-screen');
        }

        function goToCreate() {
            loadPlaylistsSelect();
            showScreen('create-screen');
        }

        function goToJoin() {
            showScreen('join-screen');
        }

        function goToPlaylists() {
            loadPlaylists();
            showScreen('playlists-screen');
        }

        function emergencyReset() {
            if (confirm('Retour au menu ? La partie en cours sera perdue.')) {
                goToMenu();
            }
        }

        // ===========================================
        // PLAYLISTS
        // ===========================================
        async function loadPlaylists() {
            const snapshot = await db.ref('playlists').once('value');
            const playlists = snapshot.val() || {};
            
            const container = document.getElementById('playlists-list');
            container.innerHTML = '';
            
            if (Object.keys(playlists).length === 0) {
                container.innerHTML = '<p style="color: #aaa; text-align: center;">Aucune playlist enregistr√©e</p>';
                return;
            }
            
            Object.entries(playlists).forEach(([id, playlist]) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.innerHTML = `
                    <span class="playlist-name">${playlist.name}</span>
                    <span class="playlist-url">${playlist.url}</span>
                    <button class="btn danger" onclick="deletePlaylist('${id}')">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        async function loadPlaylistsSelect() {
            const snapshot = await db.ref('playlists').once('value');
            const playlists = snapshot.val() || {};
            
            const select = document.getElementById('playlist-select');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            
            Object.entries(playlists).forEach(([id, playlist]) => {
                const option = document.createElement('option');
                option.value = playlist.url;
                option.textContent = playlist.name;
                select.appendChild(option);
            });
        }

        function showAddPlaylist() {
            document.getElementById('add-playlist-form').classList.remove('hidden');
        }

        async function savePlaylist() {
            const name = document.getElementById('new-playlist-name').value.trim();
            const url = document.getElementById('new-playlist-url').value.trim();
            
            if (!name || !url) {
                alert('‚ö†Ô∏è Remplis tous les champs !');
                return;
            }
            
            const match = url.match(/playlist\/(\d+)/);
            if (!match) {
                alert('‚ùå URL Deezer invalide !');
                return;
            }
            
            await db.ref('playlists').push({
                name,
                url,
                createdAt: Date.now()
            });
            
            alert('‚úÖ Playlist enregistr√©e !');
            document.getElementById('new-playlist-name').value = '';
            document.getElementById('new-playlist-url').value = '';
            document.getElementById('add-playlist-form').classList.add('hidden');
            loadPlaylists();
        }

        async function deletePlaylist(id) {
            if (confirm('Supprimer cette playlist ?')) {
                await db.ref(`playlists/${id}`).remove();
                loadPlaylists();
            }
        }

        // ===========================================
        // CREATE
        // ===========================================
        function selectNumQ(num) {
            gameState.numQuestions = num;
            document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function switchPlaylistTab(tab) {
            const deezerTab = document.getElementById('deezer-tab');
            const customTab = document.getElementById('custom-tab');
            const deezerBtn = document.getElementById('tab-deezer');
            const customBtn = document.getElementById('tab-custom');
            
            if (tab === 'deezer') {
                deezerTab.style.display = 'block';
                customTab.style.display = 'none';
                deezerBtn.style.background = '#ffbe0b';
                customBtn.style.background = 'rgba(255,255,255,0.1)';
            } else {
                deezerTab.style.display = 'none';
                customTab.style.display = 'block';
                deezerBtn.style.background = 'rgba(255,255,255,0.1)';
                customBtn.style.background = '#ffbe0b';
            }
        }

        async function loadAndCreate() {
            const name = document.getElementById('create-name').value.trim();
            const mode = document.getElementById('create-mode').value;
            const hostMode = document.getElementById('host-mode').checked;
            const distanceMode = document.getElementById('distance-mode').checked;
            
            if (!name) {
                alert('‚ö†Ô∏è Entre ton pseudo !');
                return;
            }
            
            // V√©rifier quel onglet est actif
            const customTab = document.getElementById('custom-tab');
            const isCustomPlaylist = customTab.style.display !== 'none';
            
            try {
                let tracks = [];
                
                if (isCustomPlaylist) {
                    // MODE PLAYLIST PERSO (JSON)
                    const jsonInput = document.getElementById('custom-json').value.trim();
                    
                    if (!jsonInput) {
                        alert('‚ö†Ô∏è Colle ton JSON dans la zone de texte !');
                        return;
                    }
                    
                    showLoading('Chargement de ta playlist perso...');
                    
                    // Parser le JSON
                    let data;
                    try {
                        data = JSON.parse(jsonInput);
                    } catch (e) {
                        throw new Error('JSON invalide ! V√©rifie qu\'il n\'y a pas d\'erreur de syntaxe.');
                    }
                    
                    // V√©rifier le format
                    if (!data.playlist || !Array.isArray(data.playlist)) {
                        throw new Error('Format JSON invalide ! Il doit contenir un tableau "playlist".');
                    }
                    
                    // Valider les musiques
                    tracks = data.playlist.filter(t => 
                        t.title && t.artist && t.preview && t.cover
                    ).map(t => ({
                        title: t.title,
                        artist: t.artist,
                        cover: t.cover,
                        preview: t.preview,
                        year: t.year || null
                    }));
                    
                    if (tracks.length === 0) {
                        throw new Error('Aucune musique valide dans le JSON !');
                    }
                    
                    alert(`‚úÖ ${tracks.length} musiques charg√©es depuis ta playlist perso !`);
                    hideLoading();
                    
                } else {
                    // MODE DEEZER (comme avant)
                    let url = document.getElementById('playlist-select').value;
                    if (!url) {
                        url = document.getElementById('custom-playlist-url').value.trim();
                    }
                    
                    if (!url) {
                        alert('‚ö†Ô∏è Choisis une playlist Deezer !');
                        return;
                    }
                    
                    const match = url.match(/playlist\/(\d+)/);
                    if (!match) {
                        alert('‚ùå URL Deezer invalide !');
                        return;
                    }
                    
                    showLoading('Chargement des musiques Deezer...');
                    tracks = await getDeezerPlaylist(match[1]);
                    
                    showLoading(`${tracks.length} musiques charg√©es. Filtrage...`);
                    tracks = await filterWorkingTracks(tracks);
                    
                    if (tracks.length < gameState.numQuestions) {
                        alert(`‚ö†Ô∏è Seulement ${tracks.length} musiques valides. Ajuste le nombre de questions.`);
                        hideLoading();
                        return;
                    }
                    
                    alert(`‚úÖ ${tracks.length} musiques Deezer pr√™tes !`);
                    hideLoading();
                }
                
                // V√©rifier qu'on a assez de musiques
                if (tracks.length < gameState.numQuestions) {
                    alert(`‚ö†Ô∏è Ta playlist n'a que ${tracks.length} musiques. Ajuste le nombre de questions !`);
                    return;
                }
                
                createRoom(name, mode, tracks, hostMode, distanceMode);
                
            } catch (e) {
                hideLoading();
                alert('‚ùå Erreur : ' + e.message);
            }
        }

        // FONCTION: Cr√©er questions avec 2 niveaux UNIQUEMENT
        function createQuestionsWithLevels(tracks, numQuestions, mode) {
            const shuffled = shuffle(tracks);
            let questions = [];
            
            // R√âPARTITION PERSONNALIS√âE : Plus de Niveau 2
            let lvl1Count, lvl2Count;
            
            if (numQuestions === 5) {
                lvl1Count = 2; lvl2Count = 3;
            } else if (numQuestions === 10) {
                lvl1Count = 4; lvl2Count = 6;
            } else if (numQuestions === 15) {
                lvl1Count = 5; lvl2Count = 10;
            } else if (numQuestions === 20) {
                lvl1Count = 6; lvl2Count = 14;
            } else if (numQuestions === 25) {
                lvl1Count = 8; lvl2Count = 17;
            } else if (numQuestions === 30) {
                lvl1Count = 10; lvl2Count = 20;
            } else {
                // Pour autres nombres : ~40% Lvl1, ~60% Lvl2
                lvl1Count = Math.floor(numQuestions * 0.4);
                lvl2Count = numQuestions - lvl1Count;
            }
            
            console.log(`üìä R√©partition: ${lvl1Count} Lvl1 + ${lvl2Count} Lvl2`);
            
            let trackIndex = 0;
            
            if (mode === 'qcm') {
                // === NIVEAU 1 : 2 choix ===
                for (let i = 0; i < lvl1Count && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'qcm',
                        level: 1,
                        qType: Math.random() > 0.5 ? 'artist' : 'title',
                        optionsCount: 2
                    });
                }
                
                // === NIVEAU 2 : 4 choix ===
                for (let i = 0; i < lvl2Count && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'qcm',
                        level: 2,
                        qType: Math.random() > 0.5 ? 'artist' : 'title',
                        optionsCount: 4
                    });
                }
                
            } else if (mode === 'writing') {
                // === NIVEAU 1 : Artiste seulement ===
                for (let i = 0; i < lvl1Count && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'writing',
                        level: 1,
                        askFor: 'artist'
                    });
                }
                
                // === NIVEAU 2 : Titre + Artiste ===
                for (let i = 0; i < lvl2Count && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'writing',
                        level: 2,
                        askFor: 'both'
                    });
                }
                
            } else if (mode === 'soiree') {
                // MODE SOIR√âE : QCM D'ABORD, PUIS √âCRITURE
                // Structure : QCM Lvl1 ‚Üí QCM Lvl2 ‚Üí √âcriture Lvl1 ‚Üí √âcriture Lvl2
                
                // Diviser en 2 : 50% QCM, 50% √âcriture
                const qcmTotal = Math.floor(numQuestions / 2);
                const writingTotal = numQuestions - qcmTotal;
                
                // R√©partition QCM : 40% Lvl1, 60% Lvl2
                const qcmLvl1 = Math.floor(qcmTotal * 0.4);
                const qcmLvl2 = qcmTotal - qcmLvl1;
                
                // R√©partition √âcriture : 40% Lvl1, 60% Lvl2
                const writingLvl1 = Math.floor(writingTotal * 0.4);
                const writingLvl2 = writingTotal - writingLvl1;
                
                console.log(`üìä Soir√©e: QCM(${qcmLvl1}+${qcmLvl2}) + √âcriture(${writingLvl1}+${writingLvl2})`);
                
                // === QCM NIVEAU 1 ===
                for (let i = 0; i < qcmLvl1 && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'qcm',
                        level: 1,
                        mode: 'qcm', // Identifier le mode parent
                        qType: Math.random() > 0.5 ? 'artist' : 'title',
                        optionsCount: 2
                    });
                }
                
                // === QCM NIVEAU 2 ===
                for (let i = 0; i < qcmLvl2 && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'qcm',
                        level: 2,
                        mode: 'qcm',
                        qType: Math.random() > 0.5 ? 'artist' : 'title',
                        optionsCount: 4
                    });
                }
                
                // === √âCRITURE NIVEAU 1 ===
                for (let i = 0; i < writingLvl1 && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'writing',
                        level: 1,
                        mode: 'writing', // Identifier le mode parent
                        askFor: 'artist'
                    });
                }
                
                // === √âCRITURE NIVEAU 2 ===
                for (let i = 0; i < writingLvl2 && trackIndex < shuffled.length; i++) {
                    questions.push({
                        ...shuffled[trackIndex++],
                        type: 'writing',
                        level: 2,
                        mode: 'writing',
                        askFor: 'both'
                    });
                }
                
            } else {
                // title-only: Niveau 2 uniquement
                questions = shuffled.slice(0, numQuestions).map(q => ({
                    ...q,
                    type: 'qcm',
                    qType: 'title',
                    level: 2,
                    optionsCount: 4
                }));
            }
            
            // NE PAS M√âLANGER ! Garder l'ordre Lvl1 ‚Üí Lvl2
            return questions;
        }

        function createRoom(name, mode, tracks, hostMode, distanceMode) {
            const code = genCode();
            
            gameState.musicDB = tracks;
            gameState.hostDisplayOnly = hostMode;
            gameState.distanceMode = distanceMode;
            
            const questions = createQuestionsWithLevels(tracks, gameState.numQuestions, mode);

            const room = {
                code,
                host: name,
                hostMode: hostMode,
                distanceMode: distanceMode,
                players: [{ name, score: 0, isHost: true }],
                questions,
                currentQ: 0,
                started: false
            };

            db.ref(`rooms/${code}`).set(room);
            
            gameState.room = room;
            gameState.playerIndex = 0;
            gameState.isHost = true;
            
            saveSession();
            goToLobby();
        }

        // ===========================================
        // JOIN
        // ===========================================
        function joinRoom() {
            const name = document.getElementById('join-name').value.trim();
            const code = document.getElementById('join-code').value.trim();

            if (!name) { alert('‚ö†Ô∏è Entre ton pseudo !'); return; }
            if (code.length !== 6) { alert('‚ö†Ô∏è Code invalide !'); return; }

            db.ref(`rooms/${code}`).once('value', snapshot => {
                const room = snapshot.val();
                
                if (!room) { alert('‚ùå Code invalide !'); return; }
                if (room.started) { alert('‚ùå Partie d√©j√† lanc√©e !'); return; }

                room.players.push({ name, score: 0 });
                db.ref(`rooms/${code}`).update({ players: room.players });

                gameState.room = room;
                gameState.playerIndex = room.players.length - 1;
                gameState.isHost = false;
                gameState.distanceMode = room.distanceMode || false;
                gameState.musicDB = room.questions;

                saveSession();
                goToLobby();
            });
        }

        // ===========================================
        // LOBBY
        // ===========================================
        function goToLobby() {
            showScreen('lobby-screen');
            
            document.getElementById('lobby-code').textContent = gameState.room.code;
            
            if (gameState.isHost) {
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('waiting-div').classList.add('hidden');
            } else {
                document.getElementById('start-btn').classList.add('hidden');
                document.getElementById('waiting-div').classList.remove('hidden');
            }

            updatePlayersList();
            listenToRoom();
        }

        function updatePlayersList() {
            const list = document.getElementById('players-list');
            const count = document.getElementById('player-count');
            
            list.innerHTML = '';
            count.textContent = gameState.room.players.length;
            
            gameState.room.players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'player';
                div.innerHTML = `
                    <span class="player-num">${i + 1}</span>
                    <span class="player-name">${p.name}</span>
                    ${p.name === gameState.room.host ? '<span>üëë</span>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function listenToRoom() {
            if (gameState.roomRef) gameState.roomRef.off();
            
            const ref = db.ref(`rooms/${gameState.room.code}`);
            gameState.roomRef = ref;

            ref.on('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;

                const oldCurrentQ = gameState.room ? gameState.room.currentQ : -1;
                gameState.room = data;

                if (currentScreen === 'lobby') {
                    updatePlayersList();
                    if (data.started) {
                        goToGame();
                    }
                }

                if (currentScreen === 'game') {
                    updateScoreboard();

                    // CAS 1 : On est en attente apr√®s rafra√Æchissement
                    if (gameState.waitingForNextQ) {
                        if (data.currentQ !== gameState.lastSeenQ && data.currentQ < data.questions.length) {
                            console.log('‚úÖ Nouvelle question d√©tect√©e apr√®s rafra√Æchissement, on reprend !');
                            gameState.waitingForNextQ = false;
                            gameState.lastSeenQ = null;
                            loadQuestion();
                        }
                        // Sinon on ne fait rien, on attend
                        return;
                    }

                    // CAS 2 : En cours de transition (on bloque loadQuestion)
                    if (gameState.transitionInProgress) {
                        return;
                    }
                    
                    // CAS 3 : Nouvelle question normale
                    if (data.currentQ !== oldCurrentQ && data.currentQ < data.questions.length) {
                        console.log('üì¢ Nouvelle question:', data.currentQ);
                        loadQuestion();
                    }
                    
                    if (data.currentQ >= data.questions.length) {
                        console.log('üèÅ Fin du jeu !');
                        goToLeaderboard();
                    }
                }
            });
        }

        function startGame() {
            db.ref(`rooms/${gameState.room.code}`).update({ started: true });
        }

        // ===========================================
        // GAME
        // ===========================================
        function goToGame() {
            // Lancer avec compte √† rebours de 10 secondes
            startGameWithCountdown();
        }

        function loadQuestion() {
            const q = gameState.room.questions[gameState.room.currentQ];
            const player = gameState.room.players[gameState.playerIndex];

            // D√âTECTION CHANGEMENT DE MODE + NIVEAU (transitions pour TOUS les joueurs)
            const prevMode = gameState.lastMode || '';
            const prevLevel = gameState.lastLevel || 0;
            const currentMode = q.mode || q.type;
            const currentLevel = q.level || 2;
            
            let transitionScreen = null;

            if (currentMode !== prevMode && prevMode) {
                if (currentMode === 'writing' && currentLevel === 1) {
                    transitionScreen = 'writing-lvl1-intro-screen';
                } else if (currentMode === 'qcm' && currentLevel === 1) {
                    transitionScreen = 'qcm-lvl1-intro-screen';
                }
            }
            
            if (!transitionScreen && currentLevel !== prevLevel && prevLevel !== 0) {
                if (currentMode === 'qcm' && currentLevel === 2) {
                    transitionScreen = 'qcm-lvl2-intro-screen';
                } else if (currentMode === 'writing' && currentLevel === 2) {
                    transitionScreen = 'writing-lvl2-intro-screen';
                }
            }

            if (transitionScreen) {
                gameState.lastMode = currentMode;
                gameState.lastLevel = currentLevel;
                gameState.transitionInProgress = true; // Bloquer le listener pendant la transition

                showScreen(transitionScreen);
                setTimeout(() => {
                    gameState.transitionInProgress = false;
                    showScreen('game-screen');
                    loadQuestion(); // Recharger ‚Äî cette fois sans transition
                }, 3000);
                return;
            }
            
            gameState.lastMode = currentMode;
            gameState.lastLevel = currentLevel;

            gameState.currentTime = 20;
            gameState.answered = false;
            gameState.audioPlaying = false;
            gameState.pendingScore = 0;

            document.getElementById('current-q').textContent = gameState.room.currentQ + 1;
            document.getElementById('total-q').textContent = gameState.room.questions.length;
            document.getElementById('player-score').textContent = player.score || 0;
            document.getElementById('timer').textContent = '20';
            
            // COVER
            const coverBox = document.querySelector('.img-box');
            if (gameState.room.hostMode && !gameState.isHost) {
                coverBox.style.display = 'none';
            } else {
                coverBox.style.display = 'block';
                document.getElementById('cover-img').style.filter = 'blur(25px)';
                document.getElementById('cover-img').src = q.cover;
            }

            document.getElementById('answer-reveal').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');

            // CACHER les r√©ponses ‚Äî on ne les montre qu'apr√®s que l'audio commence
            document.getElementById('options-container').classList.add('hidden');
            document.getElementById('writing-container').classList.add('hidden');

            updateScoreboard();

            // Audio
            const audioBox = document.getElementById('audio-box');
            const audio = document.getElementById('audio-player');
            
            if (gameState.distanceMode || gameState.isHost) {
                audioBox.classList.remove('hidden');
                audio.src = q.preview;
                audio.load();
                
                if (gameState.distanceMode && gameState.isHost) {
                    const startTime = Date.now() + 500;
                    db.ref(`rooms/${gameState.room.code}/audioStartTime`).set(startTime);
                }
                
                setTimeout(() => {
                    if (gameState.distanceMode && !gameState.isHost) {
                        db.ref(`rooms/${gameState.room.code}/audioStartTime`).once('value', snapshot => {
                            const startTime = snapshot.val();
                            if (startTime) {
                                const delay = Math.max(0, startTime - Date.now());
                                setTimeout(() => {
                                    audio.play().catch(err => console.error('‚ùå Audio:', err));
                                }, delay);
                            } else {
                                audio.play().catch(err => console.error('‚ùå Audio:', err));
                            }
                        });
                    } else {
                        audio.play()
                            .then(() => {
                                console.log('‚úÖ Audio lanc√©');
                                gameState.audioPlaying = true;
                            })
                            .catch(err => {
                                console.error('‚ùå Erreur audio:', err);
                            });
                    }
                }, 500);
            } else {
                audioBox.classList.add('hidden');
            }

            // MODE H√îTE : ne pas afficher les questions
            if (gameState.hostDisplayOnly) {
                document.getElementById('question-text').textContent = 'üéÆ Mode Affichage';
                startTimer();
                return;
            }

            // Charger les options EN ARRI√àRE PLAN (pas encore visibles)
            if (q.type === 'qcm') {
                loadQCM(q);
                document.getElementById('options-container').classList.add('hidden');
            } else {
                loadWriting(q);
                document.getElementById('writing-container').classList.add('hidden');
            }

            // R√âV√âLER les r√©ponses apr√®s 500ms (quand l'audio commence)
            setTimeout(() => {
                if (q.type === 'qcm') {
                    document.getElementById('options-container').classList.remove('hidden');
                } else {
                    document.getElementById('writing-container').classList.remove('hidden');
                }
            }, 500);

            startTimer();
        }

        function updateScoreboard() {
            const container = document.getElementById('live-scores');
            const scoreboard = document.getElementById('scoreboard-side');
            
            // Scoreboard visible SEULEMENT pour l'h√¥te ET si pas en mode distance
            if (!gameState.isHost || gameState.distanceMode) {
                scoreboard.style.display = 'none';
                return;
            }
            
            scoreboard.style.display = 'block';
            container.innerHTML = '';

            const sorted = [...gameState.room.players].sort((a, b) => (b.score || 0) - (a.score || 0));

            sorted.forEach(p => {
                const div = document.createElement('div');
                div.className = 'score-item';
                if (p.name === gameState.room.players[gameState.playerIndex].name) {
                    div.classList.add('me');
                }
                div.innerHTML = `
                    <span class="score-name">${p.name}</span>
                    <span class="score-points">${p.score || 0}</span>
                `;
                container.appendChild(div);
            });
        }

        function loadQCM(q) {
            const type = q.qType || 'title';
            const correct = q[type];
            const level = q.level || 2;
            
            // Afficher niveau
            const levelText = level === 1 ? " (Facile)" : level === 3 ? " (Difficile)" : "";
            document.getElementById('question-text').textContent = 
                (type === 'artist' ? "Qui est l'artiste ?" : "Quel est le titre ?") + levelText;

            // Si on a d√©j√† les options dans la room Firebase ‚Üí on les utilise directement
            const storedOptions = gameState.room.currentOptions;
            if (storedOptions && storedOptions.questionIndex === gameState.room.currentQ) {
                renderQCMOptions(storedOptions.options, correct);
                return;
            }

            // Sinon on g√©n√®re (normalement seul l'h√¥te arrive ici en premier)
            let options = [];
            
            const allTracks = gameState.musicDB;
            const usedValues = gameState.usedQCMValues || [];
            
            let wrongPool = shuffle(
                allTracks.filter(t => 
                    t[type] !== correct && 
                    !usedValues.includes(t[type])
                )
            );
            
            if (wrongPool.length < 3) {
                wrongPool = shuffle(allTracks.filter(t => t[type] !== correct));
            }
            
            options = [correct];
            const newUsed = [correct];
            
            const targetCount = q.optionsCount || 4;
            
            while (options.length < targetCount && wrongPool.length > 0) {
                const track = wrongPool.pop();
                const val = track[type];
                if (val && !options.includes(val)) {
                    options.push(val);
                    newUsed.push(val);
                }
            }

            gameState.usedQCMValues = [...usedValues, ...newUsed].slice(-20);

            const shuffledOptions = shuffle(options);

            // Sauvegarder dans Firebase pour que tous voient les m√™mes options
            db.ref(`rooms/${gameState.room.code}/currentOptions`).set({
                questionIndex: gameState.room.currentQ,
                options: shuffledOptions
            });

            renderQCMOptions(shuffledOptions, correct);
        }

        function renderQCMOptions(shuffledOptions, correct) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            container.classList.remove('hidden');
            document.getElementById('writing-container').classList.add('hidden');

            shuffledOptions.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt';
                btn.textContent = opt;
                btn.onclick = () => submitQCM(opt, correct);
                container.appendChild(btn);
            });

            gameState.correctAnswer = correct;
        }

        // G√©n√©rer variantes d'orthographe pour Lvl 3
        function loadWriting(q) {
            const level = q.level || 2;
            const askFor = q.askFor || 'both';
            
            document.getElementById('options-container').classList.add('hidden');
            document.getElementById('writing-container').classList.remove('hidden');
            document.getElementById('input-title').value = '';
            document.getElementById('input-artist').value = '';
            
            // Afficher/cacher inputs selon niveau
            const titleInput = document.getElementById('input-title');
            const artistInput = document.getElementById('input-artist');
            
            // R√âINITIALISER les styles (enlever orange/vert/rouge)
            titleInput.style.borderColor = '';
            titleInput.style.background = '';
            artistInput.style.borderColor = '';
            artistInput.style.background = '';
            
            if (askFor === 'artist') {
                // LVL 1: Artiste seulement
                document.getElementById('question-text').textContent = "√âcris l'artiste (Facile)";
                titleInput.style.display = 'none';
                artistInput.style.display = 'block';
                artistInput.placeholder = "Artiste";
            } else if (askFor === 'both') {
                // LVL 2: Titre + Artiste
                document.getElementById('question-text').textContent = "√âcris le titre et l'artiste";
                titleInput.style.display = 'block';
                artistInput.style.display = 'block';
                titleInput.placeholder = "Titre";
                artistInput.placeholder = "Artiste";
            } else if (askFor === 'both_year') {
                // LVL 3: Titre + Artiste + Ann√©e
                document.getElementById('question-text').textContent = "√âcris le titre, l'artiste et l'ann√©e (Difficile)";
                titleInput.style.display = 'block';
                artistInput.style.display = 'block';
                titleInput.placeholder = "Titre";
                artistInput.placeholder = "Artiste + Ann√©e";
            }
            
            // Stocker le niveau dans gameState
            gameState.currentWritingLevel = {
                level,
                askFor,
                year: q.year
            };
        }

        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);

            gameState.timerInterval = setInterval(() => {
                gameState.currentTime--;
                document.getElementById('timer').textContent = gameState.currentTime;

                if (!gameState.answered) {
                    const blur = (gameState.currentTime / 20) * 25;
                    document.getElementById('cover-img').style.filter = `blur(${blur}px)`;
                }

                if (gameState.currentTime <= 0) {
                    clearInterval(gameState.timerInterval);
                    
                    document.getElementById('cover-img').style.filter = 'blur(0px)';
                    
                    const q = gameState.room.questions[gameState.room.currentQ];
                    
                    // AFFICHER LA R√âPONSE
                    document.getElementById('answer-text').textContent = `${q.title} - ${q.artist}`;
                    document.getElementById('answer-reveal').classList.remove('hidden');
                    
                    // AFFICHER LE FEEDBACK (QCM)
                    if (q.type === 'qcm' && gameState.answered) {
                        const correct = q[q.qType];
                        document.querySelectorAll('.opt').forEach(btn => {
                            // Enlever le style jaune d'attente
                            btn.style.background = '';
                            btn.style.borderColor = '';
                            
                            // Mettre vert ou rouge
                            if (btn.textContent === correct) {
                                btn.classList.add('correct');
                            } else {
                                btn.classList.add('wrong');
                            }
                        });
                        
                        const pts = gameState.pendingScore || 0;
                        const isCorrect = gameState.pendingCorrect || false;
                        showResult(isCorrect, pts, `${q.title} - ${q.artist}`);
                    }
                    
                    // AFFICHER LE FEEDBACK (√âCRITURE)
                    if (q.type === 'writing' && gameState.answered) {
                        const titleInputEl = document.getElementById('input-title');
                        const artistInputEl = document.getElementById('input-artist');
                        const titleOk = gameState.pendingTitleOk;
                        const artistOk = gameState.pendingArtistOk;
                        
                        // Changer ORANGE ‚Üí VERT/ROUGE
                        if (titleInputEl.value.trim()) {
                            if (titleOk) {
                                titleInputEl.style.borderColor = '#00ff64';
                                titleInputEl.style.background = 'rgba(0, 255, 100, 0.2)';
                            } else {
                                titleInputEl.style.borderColor = '#ff0033';
                                titleInputEl.style.background = 'rgba(255, 0, 51, 0.2)';
                            }
                        }
                        
                        if (artistInputEl.value.trim()) {
                            if (artistOk) {
                                artistInputEl.style.borderColor = '#00ff64';
                                artistInputEl.style.background = 'rgba(0, 255, 100, 0.2)';
                            } else {
                                artistInputEl.style.borderColor = '#ff0033';
                                artistInputEl.style.background = 'rgba(255, 0, 51, 0.2)';
                            }
                        }
                        
                        const pts = gameState.pendingScore || 0;
                        const isCorrect = gameState.pendingCorrect || false;
                        const feedback = gameState.pendingFeedback || '';
                        showResult(isCorrect, pts, `${q.title} - ${q.artist}`, feedback);
                    }
                    
                    // DONNER LES POINTS MAINTENANT
                    if (gameState.answered && gameState.pendingScore) {
                        updateScore(gameState.pendingScore);
                    }
                    
                    // Arr√™ter l'audio
                    if (gameState.distanceMode || gameState.isHost) {
                        document.getElementById('audio-player').pause();
                    }

                    if (gameState.isHost && !gameState.answered) {
                        gameState.answered = true;
                    }
                    
                    // ATTENDRE 5 SECONDES pour voir la r√©ponse
                    setTimeout(() => {
                        if (gameState.isHost) {
                            db.ref(`rooms/${gameState.room.code}/currentQ`).once('value', snapshot => {
                                const currentQ = snapshot.val();
                                db.ref(`rooms/${gameState.room.code}/currentQ`).set(currentQ + 1);
                            });
                        }
                    }, 5000); // 5 secondes au lieu de 2.5
                }
            }, 1000);
        }

        function submitQCM(answer, correct) {
            if (gameState.answered) return;
            gameState.answered = true;

            const isCorrect = answer === correct;
            const pts = isCorrect ? (50 + gameState.currentTime * 10) : 0;
            
            // STOCKER le score en attente (sera appliqu√© √† 0s)
            gameState.pendingScore = pts;
            gameState.pendingCorrect = isCorrect;
            gameState.pendingAnswer = answer; // Stocker la r√©ponse choisie
            
            // D√©sactiver les boutons + JAUNE sur celui choisi
            document.querySelectorAll('.opt').forEach(btn => {
                btn.classList.add('disabled');
                btn.onclick = null;
                
                // Mettre en JAUNE la r√©ponse choisie
                if (btn.textContent === answer) {
                    btn.style.background = 'rgba(255, 190, 11, 0.3)';
                    btn.style.borderColor = '#ffbe0b';
                }
            });
            
            // PAS de feedback imm√©diat ! Attendre 0s
        }

        function submitWriting() {
            if (gameState.answered) return;
            
            const q = gameState.room.questions[gameState.room.currentQ];
            const levelInfo = gameState.currentWritingLevel || { askFor: 'both' };
            const titleInput = document.getElementById('input-title').value.toLowerCase().trim();
            const artistInput = document.getElementById('input-artist').value.toLowerCase().trim();

            // VALIDATION selon niveau
            if (levelInfo.askFor === 'artist' && !artistInput) {
                alert('‚ö†Ô∏è Entre l\'artiste !');
                return;
            }
            if (levelInfo.askFor === 'both' && !titleInput && !artistInput) {
                alert('‚ö†Ô∏è Entre au moins le titre OU l\'artiste !');
                return;
            }
            if (levelInfo.askFor === 'both_year' && (!titleInput || !artistInput)) {
                alert('‚ö†Ô∏è Entre le titre ET l\'artiste (+ ann√©e optionnelle) !');
                return;
            }

            gameState.answered = true;

            // VALIDATION PARFAITE : √âcriture exacte (ignorer majuscules)
            const titleNormalized = q.title.toLowerCase().trim();
            const artistNormalized = q.artist.toLowerCase().trim();
            
            const titleOk = titleInput && titleInput === titleNormalized;
            const artistOk = artistInput && artistNormalized.split(/[,&]|feat\.?/).map(a => a.trim()).includes(artistInput);

            // Check ANN√âE (Lvl 3)
            let yearOk = true;
            if (levelInfo.askFor === 'both_year' && levelInfo.year) {
                const yearMatch = artistInput.match(/\d{4}/);
                if (yearMatch) {
                    const guessYear = parseInt(yearMatch[0]);
                    yearOk = Math.abs(guessYear - levelInfo.year) <= 5;
                }
            }

            let isCorrect = false;
            let pts = 0;
            let feedback = '';

            // SCORING selon niveau
            if (levelInfo.askFor === 'artist') {
                // Lvl 1: Artiste seulement
                if (artistOk) {
                    isCorrect = true;
                    pts = 50 + gameState.currentTime * 10;
                    feedback = 'Parfait !';
                }
            } else if (levelInfo.askFor === 'both') {
                // Lvl 2: Titre + Artiste
                if (titleOk && artistOk) {
                    isCorrect = true;
                    pts = 50 + gameState.currentTime * 10;
                    feedback = 'Parfait !';
                } else if (titleOk) {
                    pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                    feedback = 'Bon titre ! (50%)';
                } else if (artistOk) {
                    pts = Math.floor((50 + gameState.currentTime * 10) * 0.5);
                    feedback = 'Bon artiste ! (50%)';
                }
            }

            // STOCKER le score en attente (sera appliqu√© √† 0s)
            gameState.pendingScore = pts;
            gameState.pendingCorrect = isCorrect;
            gameState.pendingFeedback = feedback;
            gameState.pendingTitleOk = titleOk;
            gameState.pendingArtistOk = artistOk;
            
            // Mettre les inputs en ORANGE (attente)
            const titleInputEl = document.getElementById('input-title');
            const artistInputEl = document.getElementById('input-artist');
            
            if (titleInputEl.value.trim()) {
                titleInputEl.style.borderColor = '#ff8c00';
                titleInputEl.style.background = 'rgba(255, 140, 0, 0.1)';
            }
            if (artistInputEl.value.trim()) {
                artistInputEl.style.borderColor = '#ff8c00';
                artistInputEl.style.background = 'rgba(255, 140, 0, 0.1)';
            }
            
            // PAS de feedback imm√©diat ! Attendre 0s
        }

        // VALIDATION AUTOMATIQUE en temps r√©el
        // Auto-validation supprim√©e - il faut cliquer sur Valider !

        function showResult(isCorrect, pts, answer, feedback = '') {
            const container = document.getElementById('result-container');
            container.classList.remove('hidden', 'correct', 'wrong');
            container.classList.add(isCorrect ? 'correct' : 'wrong');
            
            if (pts > 0) {
                container.textContent = `üéâ ${feedback} +${pts} pts`;
            } else {
                container.textContent = `‚ùå ${answer}`;
            }
        }

        function updateScore(pts) {
            if (pts <= 0) return;
            
            const myName = gameState.room.players[gameState.playerIndex].name;
            const playersRef = db.ref(`rooms/${gameState.room.code}/players`);
            
            // Transaction atomique : lit, modifie, √©crit sans conflit
            playersRef.transaction(function(currentPlayers) {
                if (!currentPlayers) return currentPlayers;
                
                // Trouver mon index par mon NOM (pas par playerIndex)
                for (let i = 0; i < currentPlayers.length; i++) {
                    if (currentPlayers[i].name === myName) {
                        currentPlayers[i].score = (currentPlayers[i].score || 0) + pts;
                        break;
                    }
                }
                
                return currentPlayers;
            });
        }

        function toggleAudio() {
            const audio = document.getElementById('audio-player');
            const btn = event.target;
            
            if (audio.paused) {
                audio.play();
                btn.textContent = 'üéµ Stop';
            } else {
                audio.pause();
                btn.textContent = 'üéµ Play';
            }
        }

        // ===========================================
        // LEADERBOARD
        // ===========================================
        function goToLeaderboard() {
            console.log('üèÜ LEADERBOARD');
            
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            if (gameState.roomRef) gameState.roomRef.off();
            clearSession();

            showScreen('leaderboard-screen');

            const players = gameState.room.players || [];
            const sorted = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));

            // Sauvegarder dans leaderboard all-time
            saveToAllTimeLeaderboard(sorted);

            const podium = document.getElementById('podium-container');
            podium.innerHTML = '';
            
            sorted.slice(0, 3).forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'podium-item';
                div.innerHTML = `
                    <div class="medal">${['ü•á','ü•à','ü•â'][i]}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-score">${p.score || 0} pts</div>
                `;
                podium.appendChild(div);
            });

            const list = document.getElementById('leaderboard-container');
            list.innerHTML = '<h3 style="color: #00f5ff; margin-bottom: 1rem;">üéØ Cette partie</h3>';
            
            sorted.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'lb-row';
                div.innerHTML = `
                    <span class="rank">#${i + 1}</span>
                    <span class="name">${p.name}</span>
                    <span class="pts">${p.score || 0} pts</span>
                `;
                list.appendChild(div);
            });

            // Afficher all-time leaderboard
            displayAllTimeLeaderboard();
        }

        async function saveToAllTimeLeaderboard(players) {
            for (const player of players) {
                if (player.score && player.score > 0) {
                    await db.ref('allTimeLeaderboard').push({
                        name: player.name,
                        score: player.score,
                        date: Date.now()
                    });
                }
            }
        }

        async function displayAllTimeLeaderboard() {
            const snapshot = await db.ref('allTimeLeaderboard')
                .orderByChild('score')
                .limitToLast(10)
                .once('value');
            
            const allTime = [];
            snapshot.forEach(child => {
                allTime.push(child.val());
            });
            
            allTime.reverse(); // Meilleurs en premier
            
            if (allTime.length > 0) {
                const container = document.getElementById('leaderboard-container');
                
                const titleDiv = document.createElement('h3');
                titleDiv.style.cssText = 'color: #ffbe0b; margin: 2rem 0 1rem; text-align: center;';
                titleDiv.textContent = 'üèÜ TOP 10 ALL-TIME';
                container.appendChild(titleDiv);
                
                allTime.forEach((entry, i) => {
                    const div = document.createElement('div');
                    div.className = 'lb-row';
                    div.style.background = 'rgba(255, 190, 11, 0.1)';
                    div.innerHTML = `
                        <span class="rank">#${i + 1}</span>
                        <span class="name">${entry.name}</span>
                        <span class="pts">${entry.score} pts</span>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function showIntroScreen(screenId) {
            showScreen(screenId);
            
            setTimeout(() => {
                showScreen('game-screen');
                loadQuestion();
            }, 3000); // 3 secondes
        }

        function startGameWithCountdown() {
            const q = gameState.room.questions[0];
            const modeTitle = q.mode === 'writing' || q.type === 'writing' ? 
                '‚úçÔ∏è MODE √âCRITURE' : 'üéÆ MODE QCM';
            
            document.getElementById('mode-start-title').textContent = modeTitle;
            showScreen('mode-start-screen');
            
            let countdown = 10;
            document.getElementById('countdown-number').textContent = countdown;
            
            const interval = setInterval(() => {
                countdown--;
                document.getElementById('countdown-number').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(interval);
                    // Afficher l'√©cran d'intro du premier niveau
                    const firstQ = gameState.room.questions[0];
                    if (firstQ.mode === 'qcm' || firstQ.type === 'qcm') {
                        showIntroScreen('qcm-lvl1-intro-screen');
                    } else {
                        showIntroScreen('writing-lvl1-intro-screen');
                    }
                }
            }, 1000);
        }

        function showLevelTransition(level) {
            const levelDesc = {
                1: 'Niveau Facile',
                2: 'Niveau Normal'
            };
            
            document.getElementById('next-level-num').textContent = level;
            document.getElementById('level-desc').textContent = levelDesc[level] || 'Niveau ' + level;
            
            showScreen('level-transition-screen');
            
            setTimeout(() => {
                showScreen('game-screen');
                loadQuestion(); // Charger la vraie question
            }, 3000); // 3 secondes de transition
        }

        function showWritingTransition() {
            showScreen('writing-transition-screen');
            
            setTimeout(() => {
                showScreen('game-screen');
                loadQuestion(); // Charger la vraie question
            }, 4000); // 4 secondes pour lire les instructions
        }

        function restartGame() {
            goToMenu();
        }

        // ===========================================
        // INIT
        // ===========================================
        console.log('‚úÖ Quiz Party V2 charg√© !');
        tryReconnect(); // Tentative de reconnexion si rafra√Æchissement
    </script>
</body>
</html>
